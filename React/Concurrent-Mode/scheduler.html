<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>任务过期时间 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="前端技术相关的文章，包含不限于vue，react，webpack，nodejs，算法等等">
    
    <link rel="preload" href="/Study-Notes/assets/css/0.styles.f25af5be.css" as="style"><link rel="preload" href="/Study-Notes/assets/js/app.3e6d690c.js" as="script"><link rel="preload" href="/Study-Notes/assets/js/2.a6634917.js" as="script"><link rel="preload" href="/Study-Notes/assets/js/29.4a50b3d3.js" as="script"><link rel="preload" href="/Study-Notes/assets/js/11.8af1e3cd.js" as="script"><link rel="prefetch" href="/Study-Notes/assets/js/10.688b02e5.js"><link rel="prefetch" href="/Study-Notes/assets/js/12.ed1e11ae.js"><link rel="prefetch" href="/Study-Notes/assets/js/13.e0a441de.js"><link rel="prefetch" href="/Study-Notes/assets/js/14.9e318840.js"><link rel="prefetch" href="/Study-Notes/assets/js/15.2da35c86.js"><link rel="prefetch" href="/Study-Notes/assets/js/16.edfc734e.js"><link rel="prefetch" href="/Study-Notes/assets/js/17.e62516cb.js"><link rel="prefetch" href="/Study-Notes/assets/js/18.fcbe9711.js"><link rel="prefetch" href="/Study-Notes/assets/js/19.848ea8b0.js"><link rel="prefetch" href="/Study-Notes/assets/js/20.84e2c5ca.js"><link rel="prefetch" href="/Study-Notes/assets/js/21.e8929a39.js"><link rel="prefetch" href="/Study-Notes/assets/js/22.b5ec8bbb.js"><link rel="prefetch" href="/Study-Notes/assets/js/23.9f77473d.js"><link rel="prefetch" href="/Study-Notes/assets/js/24.b73b4835.js"><link rel="prefetch" href="/Study-Notes/assets/js/25.d3f53bc9.js"><link rel="prefetch" href="/Study-Notes/assets/js/26.0edb0ed1.js"><link rel="prefetch" href="/Study-Notes/assets/js/27.d1241423.js"><link rel="prefetch" href="/Study-Notes/assets/js/28.4c683c95.js"><link rel="prefetch" href="/Study-Notes/assets/js/3.298d34ff.js"><link rel="prefetch" href="/Study-Notes/assets/js/30.39627cc1.js"><link rel="prefetch" href="/Study-Notes/assets/js/31.16a780c8.js"><link rel="prefetch" href="/Study-Notes/assets/js/32.2a86efb9.js"><link rel="prefetch" href="/Study-Notes/assets/js/33.f79801e3.js"><link rel="prefetch" href="/Study-Notes/assets/js/34.968a05eb.js"><link rel="prefetch" href="/Study-Notes/assets/js/35.69337fd1.js"><link rel="prefetch" href="/Study-Notes/assets/js/36.ec349609.js"><link rel="prefetch" href="/Study-Notes/assets/js/37.519aff5d.js"><link rel="prefetch" href="/Study-Notes/assets/js/38.6406e133.js"><link rel="prefetch" href="/Study-Notes/assets/js/39.e7043c95.js"><link rel="prefetch" href="/Study-Notes/assets/js/4.1aa99c85.js"><link rel="prefetch" href="/Study-Notes/assets/js/40.d9d172d5.js"><link rel="prefetch" href="/Study-Notes/assets/js/41.fc3c4287.js"><link rel="prefetch" href="/Study-Notes/assets/js/42.fd672b5e.js"><link rel="prefetch" href="/Study-Notes/assets/js/43.9fb62012.js"><link rel="prefetch" href="/Study-Notes/assets/js/5.5b093e25.js"><link rel="prefetch" href="/Study-Notes/assets/js/6.1b04e60d.js"><link rel="prefetch" href="/Study-Notes/assets/js/7.3721a9de.js"><link rel="prefetch" href="/Study-Notes/assets/js/8.fe0c5169.js"><link rel="prefetch" href="/Study-Notes/assets/js/9.60827e68.js">
    <link rel="stylesheet" href="/Study-Notes/assets/css/0.styles.f25af5be.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Study-Notes/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Study-Notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/Study-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Study-Notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/Study-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Study-Notes/" aria-current="page" class="sidebar-link">主页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/JavaScript/小顶堆.html" class="sidebar-link">小顶堆</a></li><li><a href="/Study-Notes/JavaScript/位运算.html" class="sidebar-link">位运算</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>React Fiber</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/React/React-Fiber/React理念.html" class="sidebar-link">React理念</a></li><li><a href="/Study-Notes/React/React-Fiber/ReactFiber架构.html" class="sidebar-link">Fiber架构</a></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>React Fiber Render</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/beginWork.html" class="sidebar-link">beginWork阶段</a></li><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/completeWork.html" class="sidebar-link">completeWork阶段</a></li><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/commit.html" class="sidebar-link">commit阶段</a></li><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/domdiff.html" class="sidebar-link">completeWork-diff阶段</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading open"><span>Concurrent Mode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/React/Concurrent-Mode/React中的事件优先级调度.html" class="sidebar-link">React事件优先级调度</a></li><li><a href="/Study-Notes/React/Concurrent-Mode/scheduler.html" aria-current="page" class="active sidebar-link">scheduler具体实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Study-Notes/React/Concurrent-Mode/scheduler.html#任务过期时间" class="sidebar-link">任务过期时间</a></li><li class="sidebar-sub-header"><a href="/Study-Notes/React/Concurrent-Mode/scheduler.html#任务队列" class="sidebar-link">任务队列</a></li><li class="sidebar-sub-header"><a href="/Study-Notes/React/Concurrent-Mode/scheduler.html#schedulecallback" class="sidebar-link">scheduleCallback</a></li><li class="sidebar-sub-header"><a href="/Study-Notes/React/Concurrent-Mode/scheduler.html#shouleyield" class="sidebar-link">shouleYield</a></li><li class="sidebar-sub-header"><a href="/Study-Notes/React/Concurrent-Mode/scheduler.html#任务调度的开始-flushwork" class="sidebar-link">任务调度的开始 flushWork</a></li></ul></li><li><a href="/Study-Notes/React/Concurrent-Mode/lane.html" class="sidebar-link">lane模型</a></li></ul></section></li><li><a href="/Study-Notes/React/React17.html" class="sidebar-link">React17</a></li><li><a href="/Study-Notes/React/React18.html" class="sidebar-link">React18</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/Vue/Vue3+Typescript实现Form组件.html" class="sidebar-link">Vue3+Typescript实现Form组件</a></li><li><a href="/Study-Notes/Vue/搭建vue3和ts组件库开发环境.html" class="sidebar-link">搭建vue3和ts组件库开发环境</a></li><li><a href="/Study-Notes/Vue/Vite2配置项目开发环境.html" class="sidebar-link">Vite2配置项目开发环境</a></li><li><a href="/Study-Notes/Vue/基于Element-plus实现虚拟下拉组件.html" class="sidebar-link">基于Element-plus实现虚拟下拉组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端生态</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/前端生态/eslint.html" class="sidebar-link">eslint</a></li><li><a href="/Study-Notes/前端生态/flutter实践.html" class="sidebar-link">flutter实践</a></li><li><a href="/Study-Notes/前端生态/flutter消息推送.html" class="sidebar-link">flutter消息推送</a></li><li><a href="/Study-Notes/前端生态/antd5架构分析.html" class="sidebar-link">antd5研究</a></li><li><a href="/Study-Notes/前端生态/element-plus架构分析.html" class="sidebar-link">element-plus样式+打包分析</a></li><li><a href="/Study-Notes/前端生态/ts类型打包.html" class="sidebar-link">ts类型打包</a></li><li><a href="/Study-Notes/前端生态/vscode扩展工具.html" class="sidebar-link">vscode扩展工具实现</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>go</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/go/mac如何安装grpc.html" class="sidebar-link">mac安装grpc</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="任务过期时间"><a href="#任务过期时间" class="header-anchor">#</a> 任务过期时间</h2> <p>在 <code>scheduler</code> 中不同的优先级对应着不同的任务过期事件，如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//每个优先级对应的任务对应一个过期时间</span>
<span class="token keyword">let</span> maxSigned31BitInt <span class="token operator">=</span> <span class="token number">1073741823</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//为负数，表明当前的任务时间已经过期了，需要立即执行</span>
<span class="token keyword">let</span> <span class="token constant">USER_BLOCKING_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">IDLE_PRIORITY_TIMEOUT</span> <span class="token operator">=</span> maxSigned31BitInt<span class="token punctuation">;</span>
</code></pre></div><h2 id="任务队列"><a href="#任务队列" class="header-anchor">#</a> 任务队列</h2> <p>在 <code>scheduler</code> 中会存在两个队列，一个叫做 <code>taskQueue</code> 这个用来存放已经开始了的任务队列，还有一个叫做 <code>timerQueue</code> ，这个用来存放尚未开始的任务队列。</p> <p>每当有新的未就绪的任务被注册，我们将其插入<code>timerQueue</code>并根据开始时间重新排列<code>timerQueue</code>中任务的顺序。</p> <p>当<code>timerQueue</code>中有任务就绪，即<code>startTime &lt;= currentTime</code>，我们将其取出并加入<code>taskQueue</code>。</p> <p>取出<code>taskQueue</code>中最早过期的任务并执行他。</p> <p>为了能在 O(1)复杂度找到两个队列中时间最早的那个任务，<code>Scheduler</code>使用<a href="https://www.cnblogs.com/lanhaicode/p/10546257.html" target="_blank" rel="noopener noreferrer">小顶堆<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>实现了<code>优先级队列</code>。</p> <blockquote><p>你可以在<a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/SchedulerMinHeap.js" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>看到<code>优先级队列</code>的实现</p></blockquote> <h2 id="schedulecallback"><a href="#schedulecallback" class="header-anchor">#</a> scheduleCallback</h2> <p>在 <code>scheduler</code> 有一个 <code>scheduleCallback</code> 方法去负责调度任务，该方法接受三个参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 调度一个任务
 * @param {*} priorityLevel  任务优先级
 * @param {*} callback  需要调度的方法
 * @param {*} options  选项，包括设置任务的一个延时时间
 */</span>
<span class="token keyword">function</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>方法执行开始，首先会去获取到一个当前时间，然后判断 options 是不是一个对象，如果是的话，会取出里面的一个过期时间字段加上当前的时间和一个任务的过期时间，来表示这个任务的一个优先级。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scheduleCallback</span><span class="token punctuation">(</span><span class="token parameter">priorityLevel<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取当前的时间</span>
  <span class="token keyword">let</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//此任务的开始时间</span>
  <span class="token keyword">let</span> startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> options <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> delay <span class="token operator">=</span> options<span class="token punctuation">.</span>delay<span class="token punctuation">;</span>
    <span class="token comment">//如果delay是一个数字，那么开始时间等于当前时间加上延迟的时间</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> delay <span class="token operator">===</span> <span class="token string">&quot;number&quot;</span> <span class="token operator">&amp;&amp;</span> delay <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      startTime <span class="token operator">=</span> currentTime <span class="token operator">+</span> delay<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//开始时间等于当前时间，也就是立刻开始</span>
      startTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//计算超时时间</span>
  <span class="token keyword">let</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>priorityLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ImmediatePriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">IMMEDIATE_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">UserBlockingPriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">USER_BLOCKING_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">NormalPriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">NORMAL_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">LowPriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">LOW_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token literal-property property">IdlePriority</span><span class="token operator">:</span>
      timeout <span class="token operator">=</span> <span class="token constant">IDLE_PRIORITY_TIMEOUT</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//计算一个过期时间 当前时间加上超时时间</span>
  <span class="token keyword">let</span> expirationTime <span class="token operator">=</span> startTime <span class="token operator">+</span> timeout<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newTask <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> taskIdCounter<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token comment">//每个任务有一个自增的ID</span>
    callback<span class="token punctuation">,</span> <span class="token comment">//真正要执行的函数calculate</span>
    priorityLevel<span class="token punctuation">,</span> <span class="token comment">//优先级</span>
    expirationTime<span class="token punctuation">,</span> <span class="token comment">//过期时间</span>
    startTime<span class="token punctuation">,</span> <span class="token comment">//开始时间</span>
    <span class="token literal-property property">sortIndex</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//排序值</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>然后我们需要判断 任务开始时间是不是大于当前时间 ，说明此任务不需要立刻开始，需要等一段时间后才开始，那么我们就会把这个任务放到 <code>timerQueue</code> 这个最小堆中去，否则就方法 <code>taskQueue</code> 里面去</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//如果说任务开始时间大于当前里说 ，说明此任务不需要立刻开始，需要等一段时间后才开始</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">&gt;</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//如果是延迟任务，那么在timeQueue中的排序依赖就是开始时间了</span>
  newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> startTime<span class="token punctuation">;</span>
  <span class="token comment">//添加到延迟任务最小堆里，优先队列里</span>
  <span class="token function">push</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//如果现在开始队列里已经为空了，并且新添加的这个延迟任务是延迟任务队队列优先级最高的那个任务</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> newTask <span class="token operator">===</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//开启一个定时器，等到此任务的开始时间到达的时候检查延迟任务并添加到taskQueue中</span>
    <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">//任务在最小堆里的排序依赖就是过期时间</span>
  newTask<span class="token punctuation">.</span>sortIndex <span class="token operator">=</span> expirationTime<span class="token punctuation">;</span>
  <span class="token comment">//向最小堆里添加一个新的任务</span>
  <span class="token function">push</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">,</span> newTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//taskQueue.push(callback);</span>
  <span class="token function">requestHostCallback</span><span class="token punctuation">(</span>flushWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<code>requestHostCallback</code>这个 方法里面，会去调用 MessageChannel 的方法，让调度的任务在浏览器的下一帧去执行，并且把当前的需要调度的方法赋值给 <code>scheduledHostCallback</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">requestHostCallback</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scheduledHostCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token comment">//一旦port2发消息了，会向宏任务队列中添加一个宏任务，执行por1.onmessage方法</span>
  <span class="token comment">//告诉 浏览器在下一帧执行performWorkUntilDeadline</span>
  messageChannel<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//requestAnimationFrame(performWorkUntilDeadline);</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="shouleyield"><a href="#shouleyield" class="header-anchor">#</a> shouleYield</h2> <p>在 <code>scheduler</code> 内部有一个 <code>shouldYieldToHost</code>方法，以下俗称 <code>shouleYield</code> 该方法主要用来判断浏览器当前渲染的这一帧是不是还有剩余时间，因为在 <code>scheduler</code> 内部，每一帧会请求浏=浏览器的 <code>5ms</code> 的时间去执行 <code>js任务</code>，如果发现 <code>5ms</code> 已经使用完了，但是 <code>js任务</code> 却还没执行完毕，那么该任务就会暂停，等待浏览器再下一帧渲染时去执行。</p> <p><strong>每一个任务在执行的过程中会去执行 <code>shouleYield</code> 方法去判断是不是需要暂停。</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> yieldInterval <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">//每一帧我会申请5ms</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//获取当前时间</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//计算截止时间  deadline 就是任务执行时的一个当前时间加上了5ms的一个申请时间 deadline = currentTime + yieldInterval;</span>
  <span class="token comment">//如果当前时间大于截止时间了，说明到期了，时间片已经用完了，需要返回true,放弃 执行了</span>
  <span class="token keyword">return</span> currentTime <span class="token operator">&gt;=</span> deadline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="任务调度的开始-flushwork"><a href="#任务调度的开始-flushwork" class="header-anchor">#</a> 任务调度的开始 flushWork</h2> <p>在 <code>flushWork</code> 函数中，会去执行 <code>workLoop</code> 函数去依次执行队列里面的任务</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 依次执行任务队列中的任务
 */</span>
<span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span><span class="token parameter">currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">workLoop</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里我们简单的看一下 mini 版本的 <code>workLoop</code> 方法吧</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 依次执行任务队列中的任务
 * 在这里有两个打断或者到停止 执行
 * 在执行每上任务的时候，如果时间片到到期了会退出workLoop
 * 另一个是在执行currentTask的时候，如果时间片到期了，也会退出执行
 */</span>
<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">currentTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//其实每次在执行workLoop的时候才会检查 延迟任务哪些可以开始执行了就放到任务队列里</span>
  <span class="token comment">//无时无刻都在检查 的</span>
  <span class="token comment">//advanceTimers(currentTime);</span>
  <span class="token comment">//取出任务队列中的第一个任务</span>
  <span class="token comment">//currentTask = taskQueue[0];</span>
  <span class="token comment">//取出优先队列中的优先最高的堆顶元素，也就是过期时间最早的元素</span>
  currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果说时间片到期了，就退出循环</span>
    <span class="token comment">//如果说过期时间大于当前时间，并且时间片到期就退出执行</span>
    <span class="token comment">//如果说已经过期了，及时时间处到期了，也需要继续执行</span>
    <span class="token comment">// 如果一个任务过期了，则不再考虑所有谓时间配额问题了，立刻马上全力执行结束</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> currentTime <span class="token operator">&amp;&amp;</span> <span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//取出当前的任务的回调函数calculate</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token comment">//如果它是一个函数的话</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//先清空callback属性</span>
      currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">//判断此任务是否过期</span>
      <span class="token keyword">const</span> didUserCallbackTimeout <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">;</span>
      <span class="token keyword">const</span> continuationCallback <span class="token operator">=</span> <span class="token function">callback</span><span class="token punctuation">(</span>didUserCallbackTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> continuationCallback <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        currentTask<span class="token punctuation">.</span>callback <span class="token operator">=</span> continuationCallback<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">//如果任务的callback属性不是函数，则将此任务出队，这个在后面的取消任务的会用到</span>
      <span class="token function">pop</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//继续取出最小堆堆顶的任务</span>
    currentTask <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>taskQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">//说明taskQueue已经空了</span>
    <span class="token keyword">const</span> firstTimer <span class="token operator">=</span> <span class="token function">peek</span><span class="token punctuation">(</span>timerQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstTimer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">requestHostTimeout</span><span class="token punctuation">(</span>handleTimeout<span class="token punctuation">,</span> firstTimer<span class="token punctuation">.</span>startTime <span class="token operator">-</span> currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div><div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Study-Notes/React/Concurrent-Mode/React中的事件优先级调度.html" class="prev">
        React事件优先级调度
      </a></span> <span class="next"><a href="/Study-Notes/React/Concurrent-Mode/lane.html">
        lane模型
      </a>
      →
    </span></p></div> <div class="icp-footer"><p>Copyright© 2022-2023 _妄想何方</p> <a href="https://beian.miit.gov.cn/" target="_blank">蜀ICP备2022010321号-1</a></div></div> </main></div><div class="global-ui"></div></div>
    <script src="/Study-Notes/assets/js/app.3e6d690c.js" defer></script><script src="/Study-Notes/assets/js/2.a6634917.js" defer></script><script src="/Study-Notes/assets/js/29.4a50b3d3.js" defer></script><script src="/Study-Notes/assets/js/11.8af1e3cd.js" defer></script>
  </body>
</html>

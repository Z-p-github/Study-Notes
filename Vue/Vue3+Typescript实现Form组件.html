<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="前端技术相关的文章，包含不限于vue，react，webpack，nodejs，算法等等">
    
    <link rel="preload" href="/assets/css/0.styles.1bd58bef.css" as="style"><link rel="preload" href="/assets/js/app.126f0258.js" as="script"><link rel="preload" href="/assets/js/2.30bd822f.js" as="script"><link rel="preload" href="/assets/js/15.11062623.js" as="script"><link rel="preload" href="/assets/js/11.b85d9fb6.js" as="script"><link rel="prefetch" href="/assets/js/10.0a7f23f5.js"><link rel="prefetch" href="/assets/js/12.ed1e11ae.js"><link rel="prefetch" href="/assets/js/13.90e0f4c3.js"><link rel="prefetch" href="/assets/js/14.3a06bb32.js"><link rel="prefetch" href="/assets/js/16.690a0ab0.js"><link rel="prefetch" href="/assets/js/17.56fb5d03.js"><link rel="prefetch" href="/assets/js/18.9ef78e2f.js"><link rel="prefetch" href="/assets/js/19.44aed15d.js"><link rel="prefetch" href="/assets/js/20.1520b443.js"><link rel="prefetch" href="/assets/js/21.1ecb9e2c.js"><link rel="prefetch" href="/assets/js/22.9c032f47.js"><link rel="prefetch" href="/assets/js/23.30e66d45.js"><link rel="prefetch" href="/assets/js/24.67f7c144.js"><link rel="prefetch" href="/assets/js/25.430a8b61.js"><link rel="prefetch" href="/assets/js/26.b0b74904.js"><link rel="prefetch" href="/assets/js/27.af28f136.js"><link rel="prefetch" href="/assets/js/28.ca92da75.js"><link rel="prefetch" href="/assets/js/29.cc7e5601.js"><link rel="prefetch" href="/assets/js/3.e545e13e.js"><link rel="prefetch" href="/assets/js/30.524144bb.js"><link rel="prefetch" href="/assets/js/31.8585f27d.js"><link rel="prefetch" href="/assets/js/32.f53bfec9.js"><link rel="prefetch" href="/assets/js/33.13a7ce60.js"><link rel="prefetch" href="/assets/js/34.5d2e856b.js"><link rel="prefetch" href="/assets/js/35.a08d0b95.js"><link rel="prefetch" href="/assets/js/36.66177157.js"><link rel="prefetch" href="/assets/js/37.12e11a01.js"><link rel="prefetch" href="/assets/js/38.0550cd6c.js"><link rel="prefetch" href="/assets/js/39.04ac9ed9.js"><link rel="prefetch" href="/assets/js/4.c18256f0.js"><link rel="prefetch" href="/assets/js/40.8f429f83.js"><link rel="prefetch" href="/assets/js/41.f5e6cf34.js"><link rel="prefetch" href="/assets/js/42.d5e97e1c.js"><link rel="prefetch" href="/assets/js/43.66ac2eb9.js"><link rel="prefetch" href="/assets/js/5.75db888e.js"><link rel="prefetch" href="/assets/js/6.2afba461.js"><link rel="prefetch" href="/assets/js/7.2f4d31d1.js"><link rel="prefetch" href="/assets/js/8.4f713717.js"><link rel="prefetch" href="/assets/js/9.a559d100.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1bd58bef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/doc-front-end" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/doc-front-end" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">主页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/JavaScript/小顶堆.html" class="sidebar-link">小顶堆</a></li><li><a href="/JavaScript/位运算.html" class="sidebar-link">位运算</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>React Fiber</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/React-Fiber/React理念.html" class="sidebar-link">React理念</a></li><li><a href="/React/React-Fiber/ReactFiber架构.html" class="sidebar-link">Fiber架构</a></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>React Fiber Render</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/React-Fiber/Fiber-dom-diff/beginWork.html" class="sidebar-link">beginWork阶段</a></li><li><a href="/React/React-Fiber/Fiber-dom-diff/completeWork.html" class="sidebar-link">completeWork阶段</a></li><li><a href="/React/React-Fiber/Fiber-dom-diff/commit.html" class="sidebar-link">commit阶段</a></li><li><a href="/React/React-Fiber/Fiber-dom-diff/domdiff.html" class="sidebar-link">completeWork-diff阶段</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>Concurrent Mode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/Concurrent-Mode/React中的事件优先级调度.html" class="sidebar-link">React事件优先级调度</a></li><li><a href="/React/Concurrent-Mode/scheduler.html" class="sidebar-link">scheduler具体实现</a></li><li><a href="/React/Concurrent-Mode/lane.html" class="sidebar-link">lane模型</a></li></ul></section></li><li><a href="/React/React17.html" class="sidebar-link">React17</a></li><li><a href="/React/React18.html" class="sidebar-link">React18</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Vue/Vue3+Typescript实现Form组件.html" class="active sidebar-link">Vue3+Typescript实现Form组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Vue/Vue3+Typescript实现Form组件.html#文件目录" class="sidebar-link">文件目录</a></li><li class="sidebar-sub-header"><a href="/Vue/Vue3+Typescript实现Form组件.html#index-ts" class="sidebar-link">index.ts</a></li><li class="sidebar-sub-header"><a href="/Vue/Vue3+Typescript实现Form组件.html#form-组件的-prop" class="sidebar-link">form 组件的 prop</a></li><li class="sidebar-sub-header"><a href="/Vue/Vue3+Typescript实现Form组件.html#form-item-的-prop" class="sidebar-link">form-item 的 prop</a></li><li class="sidebar-sub-header"><a href="/Vue/Vue3+Typescript实现Form组件.html#form-item-实现" class="sidebar-link">form-item 实现</a></li><li class="sidebar-sub-header"><a href="/Vue/Vue3+Typescript实现Form组件.html#验证" class="sidebar-link">验证</a></li><li class="sidebar-sub-header"><a href="/Vue/Vue3+Typescript实现Form组件.html#使用方式" class="sidebar-link">使用方式</a></li></ul></li><li><a href="/Vue/搭建vue3和ts组件库开发环境.html" class="sidebar-link">搭建vue3和ts组件库开发环境</a></li><li><a href="/Vue/Vite2配置项目开发环境.html" class="sidebar-link">Vite2配置项目开发环境</a></li><li><a href="/Vue/基于Element-plus实现虚拟下拉组件.html" class="sidebar-link">基于Element-plus实现虚拟下拉组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端生态</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/前端生态/eslint.html" class="sidebar-link">eslint</a></li><li><a href="/前端生态/flutter实践.html" class="sidebar-link">flutter实践</a></li><li><a href="/前端生态/flutter消息推送.html" class="sidebar-link">flutter消息推送</a></li><li><a href="/前端生态/antd5架构分析.html" class="sidebar-link">antd5研究</a></li><li><a href="/前端生态/element-plus架构分析.html" class="sidebar-link">element-plus样式+打包分析</a></li><li><a href="/前端生态/ts类型打包.html" class="sidebar-link">ts类型打包</a></li><li><a href="/前端生态/vscode扩展工具.html" class="sidebar-link">vscode扩展工具实现</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>go</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/go/mac如何安装grpc.html" class="sidebar-link">mac安装grpc</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><code>Vue3+Typescript</code> 目前已经如日中天了，现在我们使用他们去实现一下现在 <code>elementui plus</code> 中的 <code>Form</code> 组件</p> <h2 id="文件目录"><a href="#文件目录" class="header-anchor">#</a> 文件目录</h2> <p>首先我们需要新建如下的目录结构</p> <img src="/assets/img/form-list.56a4b05e.png" alt="form-list" height="300"> <ul><li>最外层的 <code>index.ts</code> 文件主要用来将我们的组件暴露出去，并且注册在 <code>vue</code> 的全局 <code>component</code></li> <li><code>form.ts</code> 用来编写 <code>Form</code> 组件需要的 <code>typescript</code> 类型定义</li> <li><code>form.vue</code> 用来编写 <code>Form</code> 的 <code>vue</code> 文件</li> <li><code>form-item.ts</code> 用来编写 <code>Form-Item</code> 组件需要的 <code>typescript</code> 类型定义</li> <li><code>form-item.vue</code> 用来编写 <code>Form—Item</code> 的 <code>vue</code> 文件</li></ul> <p>接下来，我们来一一实现这几个文件里面的内容</p> <h2 id="index-ts"><a href="#index-ts" class="header-anchor">#</a> index.ts</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> _FormItem <span class="token keyword">from</span> <span class="token string">&quot;./src/form-item.vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> _Form <span class="token keyword">from</span> <span class="token string">&quot;./src/form.vue&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> Plugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//install安装方法</span>
<span class="token keyword">type</span> <span class="token class-name">SFCInstall<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token operator">&amp;</span> Plugin<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">Install</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>comp<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span>comp <span class="token keyword">as</span> SFCInstall<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> comp <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> comp<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将组件注册成全局的组件</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> comp <span class="token keyword">as</span> SFCInstall<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//form-item，给组件实例上面加上install方法</span>
<span class="token keyword">const</span> FormItem <span class="token operator">=</span> <span class="token function">Install</span><span class="token punctuation">(</span>_FormItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//form，给组件实例上面加上install方法</span>
<span class="token keyword">const</span> Form <span class="token operator">=</span> <span class="token function">Install</span><span class="token punctuation">(</span>_Form<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//暴露出去</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> FormItem<span class="token punctuation">,</span> Form <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//暴露出组件的 ts 类型</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> FormItemProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./src/form-item&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> FormProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./src/form&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//暴露组件构造函数类型的实例类型。</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">FormInstance</span> <span class="token operator">=</span> InstanceType<span class="token operator">&lt;</span><span class="token keyword">typeof</span> Form<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">//在 vue module下面 GlobalComponents 接口扩展两个组件类型</span>
<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">&quot;vue&quot;</span> <span class="token punctuation">{</span>
  <span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">GlobalComponents</span> <span class="token punctuation">{</span>
    FormItem<span class="token operator">:</span> <span class="token keyword">typeof</span> FormItem<span class="token punctuation">;</span>
    Form<span class="token operator">:</span> <span class="token keyword">typeof</span> Form<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们在封装的时候就首先要考虑到我们组件需要接受哪些参数，然后将这些参数在<code>ts</code>类型文件中定义出来</p> <h2 id="form-组件的-prop"><a href="#form-组件的-prop" class="header-anchor">#</a> form 组件的 prop</h2> <ul><li><code>model</code> 数据源</li> <li><code>rules</code> 用来配置校验数据的规则</li></ul> <h2 id="form-item-的-prop"><a href="#form-item-的-prop" class="header-anchor">#</a> form-item 的 prop</h2> <ul><li>prop 校验表单控件的属性</li> <li>label 属性表单控件的标题</li> <li>rules 表单控件的规则</li> <li>show-message 是否显示错误，默认为 true</li></ul> <p>这里我们从里往外实现，先实现 <code>form-item</code> ，再来实现 <code>form</code>组件，<code>form</code>组件主要是用来管理所有的<code>form-item</code></p> <h2 id="form-item-实现"><a href="#form-item-实现" class="header-anchor">#</a> form-item 实现</h2> <p>首先我们需要来定义 <code>form-item</code> 的 ts 类型申明文件</p> <p>在 <code>form-item</code> 中 需要管理自己对应的 prop 的规则校验，这里需要借助 <code>async-validator</code> 这个库来进行校验</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> RuleItem <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;async-validator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ExtractPropTypes<span class="token punctuation">,</span> InjectionKey<span class="token punctuation">,</span> PropType<span class="token punctuation">,</span> VNodeChild <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Arrayable<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//定义规则的type</span>
<span class="token class-name"><span class="token keyword">export</span></span> <span class="token keyword">interface</span> <span class="token class-name">FormItemRule</span> <span class="token keyword">extends</span> <span class="token class-name">RuleItem</span> <span class="token punctuation">{</span>
  trigger<span class="token operator">?</span><span class="token operator">:</span> Arrayable<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> formItemValidateState <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;success&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token comment">//验证的状态，as const 将类型变为 readOnly ，不可以修改 =》 &quot;&quot; | &quot;success&quot; | &quot;error&quot;</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">FormItemValidateState</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> formItemValidateState<span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//form-item的prop</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> formItemProps <span class="token operator">=</span> <span class="token punctuation">{</span>
  prop<span class="token operator">:</span> String<span class="token punctuation">,</span>
  label<span class="token operator">:</span> String<span class="token punctuation">,</span>
  rules<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">,</span> <span class="token builtin">Array</span><span class="token punctuation">]</span> <span class="token keyword">as</span> PropType<span class="token operator">&lt;</span>Arrayable<span class="token operator">&lt;</span>FormItemRule<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
  showMessage<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> Boolean<span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

<span class="token comment">//将form-item的prop转为可选择的 ，例如 readonly showMessage?: boolean | undefined;</span>
<span class="token comment">//ExtractPropTypes 可将 Constructor 转换为对应值类型</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">FormItemProps</span> <span class="token operator">=</span> Partial<span class="token operator">&lt;</span>ExtractPropTypes<span class="token operator">&lt;</span><span class="token keyword">typeof</span> formItemProps<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>接着我们去编写 <code>form-item</code> 的 <code>template</code></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 给最外层的容器绑定几个class --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
    <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[
      <span class="token punctuation">'</span>form-item-warpper<span class="token punctuation">'</span>,
      validateState === <span class="token punctuation">'</span>success<span class="token punctuation">'</span> ? <span class="token punctuation">'</span>form-item-success<span class="token punctuation">'</span> : <span class="token punctuation">'</span><span class="token punctuation">'</span>,
      validateState === <span class="token punctuation">'</span>error<span class="token punctuation">'</span> ? <span class="token punctuation">'</span>form-item-error<span class="token punctuation">'</span> : <span class="token punctuation">'</span><span class="token punctuation">'</span>,
    ]<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 存放label --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form-item-labe<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- 定义一个插槽，如果不自定义，那么就是用默认的label来展示 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>label<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        {{ label }}
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span>
    <span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 定义一个content --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form-item-content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- 存放表单控件的默认插槽 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- 存放错误的信息msg --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form-item-error<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>error<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
          {{ validateMessage }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><img src="/assets/img/form.b6638ba4.png" alt="form" height="300"> <p>在 <code>form</code> 中 我们需要通过 <code>provider</code> 方法 向下层的 <code>form-item</code> 提供自己的上下文属性 ，因为后续的校验逻辑需要 <code>form</code> 去 统一去触发 每一个<code>form-item</code>的<code>validate</code>，并且 在 <code>form-item</code>中也需要知道是否外层的 <code>form</code>组件也配置了<code>rules</code> 属性，这儿就会涉及到一个规则的合并。</p> <p><code>form.vue</code></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>form<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>slot</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> Values <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;async-validator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formProps<span class="token punctuation">,</span> FormContextKey<span class="token punctuation">,</span> FormContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./form&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormItemContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./form-item&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//给组件取名字</span>
<span class="token function">defineOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;form&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//定义组件的prop</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">defineProps</span><span class="token punctuation">(</span>formProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//定义需要传递的上下文</span>
<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>props<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//向下暴露出去 FormContextKey 是一个symbol变量</span>
<span class="token function">provide</span><span class="token punctuation">(</span>FormContextKey<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将form表单的校验方法 暴露给用户，用户可以通过ref来进行检测</span>
<span class="token function">defineExpose</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  validate<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>form</code>组件暴露了上下文之后，<code>form-item</code>组件中需要接收这个 上下文，并且需要合并一下 <code>form</code> 和 自己组件接收到的规则，并且也需要将自己的上下文暴露给 <code>form</code>组件，方便后续<code>form</code>统一触发规则校验</p> <p><code>form-item</code></p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@vue/reactivity&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> inject<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormContextKey <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./form&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Arrayable<span class="token punctuation">,</span> FormItemRule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./form-item&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> formItemProps<span class="token punctuation">,</span> FormItemContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./form-item&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//注入 form 的上下文</span>
<span class="token keyword">const</span> formContext <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>FormContextKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//定义组件的prop</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">defineProps</span><span class="token punctuation">(</span>formItemProps<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 增加组件名字</span>
<span class="token function">defineOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;form-item&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//转化为数组</span>
<span class="token keyword">const</span> converArray <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token literal-property property">rules</span><span class="token operator">:</span> Arrayable<span class="token operator">&lt;</span>FormItemRule<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token punctuation">)</span><span class="token operator">:</span> FormItemRule<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> rules <span class="token operator">?</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span> <span class="token operator">?</span> rules <span class="token operator">:</span> <span class="token punctuation">[</span>rules<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//组合 form 和自己的 规则</span>
<span class="token keyword">const</span> _rules <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> myRules <span class="token operator">=</span> <span class="token function">converArray</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自己的规则</span>
  <span class="token keyword">const</span> formRules <span class="token operator">=</span> formContext<span class="token operator">?.</span>rules<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>formRules <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>prop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _temp <span class="token operator">=</span> formRules<span class="token punctuation">[</span>props<span class="token punctuation">.</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_temp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      myRules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">converArray</span><span class="token punctuation">(</span>_temp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> myRules<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//验证的方法</span>
<span class="token keyword">const</span> <span class="token literal-property property">validate</span><span class="token operator">:</span> FormItemContext<span class="token punctuation">[</span><span class="token string">&quot;validate&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">trigger<span class="token punctuation">,</span> callback<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token literal-property property">context</span><span class="token operator">:</span> FormItemContext <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>props<span class="token punctuation">,</span>
  validate<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//像下级组件暴露 上下文， 例如 el-input  el-select 等</span>
<span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">&quot;form-item&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  formContext<span class="token operator">?.</span><span class="token function">addField</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将自己的上下文传递给了父亲</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在 <code>form</code> 组件中需要提供一个 <code>addField</code> 方法 去收集 子组件 <code>form-item</code> 的上下文</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> <span class="token literal-property property">fields</span><span class="token operator">:</span> FormItemContext<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 父亲收集儿子</span>

<span class="token keyword">const</span> <span class="token literal-property property">addField</span><span class="token operator">:</span> FormContext<span class="token punctuation">[</span><span class="token string">&quot;addField&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  fields<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>props<span class="token punctuation">,</span>
  addField<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h2> <p>当我们在使用 <code>form</code> 的父组件中 进行验证时，想要 去调用 <code>form</code>组件内部的 <code>validate</code> 方法 ，由 <code>form</code>组件再去 触发每一个 <code>form-item</code>自己的验证</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> formRef <span class="token operator">=</span> ref<span class="token operator">&lt;</span>FormInstance<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">validateForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取到form实例</span>
  <span class="token keyword">const</span> form <span class="token operator">=</span> formRef<span class="token punctuation">.</span>value
  form<span class="token operator">?.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">valid<span class="token punctuation">,</span> errors</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>valid<span class="token punctuation">,</span> errors<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>form</code> 的验证方法</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// form的校验,在父级中调用所有儿子的校验方法</span>
<span class="token keyword">const</span> <span class="token function-variable function">validate</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  <span class="token parameter">callback<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">valid</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span> fields<span class="token operator">?</span><span class="token operator">:</span> Values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span></span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token literal-property property">errors</span><span class="token operator">:</span> Values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//循环所有的 form-item</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> field <span class="token keyword">of</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> field<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      errors <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>errors<span class="token punctuation">,</span>
        <span class="token operator">...</span><span class="token punctuation">(</span>error <span class="token keyword">as</span> Values<span class="token punctuation">)</span><span class="token punctuation">.</span>fields
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 没有错误就成功</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> callback<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 有错误就失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      callback<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> errors<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>每一个<code>form-item</code>中的验证方法</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// 过滤出对应 触发方式 的规则</span>
<span class="token keyword">const</span> <span class="token function-variable function">getRuleFiltered</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">trigger</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> rules <span class="token operator">=</span> _rules<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token keyword">return</span> rules<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rule<span class="token punctuation">.</span>trigger <span class="token operator">||</span> <span class="token operator">!</span>trigger<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 这种情况意味着无论如何都要校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span>trigger<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> rule<span class="token punctuation">.</span>trigger<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> rule<span class="token punctuation">.</span>trigger <span class="token operator">===</span> trigger<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//验证成功的函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">onValidationSuccesseded</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  validateState<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;success&quot;</span><span class="token punctuation">;</span>
  validateMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//验证失败的函数 ，改变对应的状态</span>
<span class="token keyword">const</span> <span class="token function-variable function">onValidationFailed</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">err</span><span class="token operator">:</span> Values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  validateState<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> errors <span class="token punctuation">}</span> <span class="token operator">=</span> err<span class="token punctuation">;</span>
  validateMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> errors <span class="token operator">?</span> errors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//验证</span>
<span class="token keyword">const</span> <span class="token literal-property property">validate</span><span class="token operator">:</span> FormItemContext<span class="token punctuation">[</span><span class="token string">&quot;validate&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">trigger<span class="token punctuation">,</span> callback<span class="token operator">?</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拿到触发的时机，校验是否通过可以调用callback 或者调用promise.then方法</span>
  <span class="token keyword">const</span> rules <span class="token operator">=</span> <span class="token function">getRuleFiltered</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// rules 就是触发的规则 , trigger就是触发的方式</span>
  <span class="token comment">// 需要找到对应的数据源头 上面找到对应的prop</span>

  <span class="token comment">// 触发事件了 ，找到对应的规则，和数据源在哪里，校验那个属性</span>
  <span class="token keyword">const</span> modelName <span class="token operator">=</span> props<span class="token punctuation">.</span>prop<span class="token operator">!</span><span class="token punctuation">;</span>
  <span class="token comment">// 拿到校验器</span>
  <span class="token keyword">const</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncValdaitor</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span>modelName<span class="token punctuation">]</span><span class="token operator">:</span> rules<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> model <span class="token operator">=</span> formContext<span class="token operator">?.</span>model<span class="token operator">!</span><span class="token punctuation">;</span><span class="token comment">//取到form上面的模型</span>

  <span class="token keyword">return</span> validator
    <span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token punctuation">[</span>modelName<span class="token punctuation">]</span><span class="token operator">:</span> model<span class="token punctuation">[</span>modelName<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//取到模型上面的值</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//处理成功</span>
      <span class="token function">onValidationSuccesseded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">err</span><span class="token operator">:</span> Values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">//处理validate个实例返回回来的错误</span>
      <span class="token function">onValidationFailed</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>到这里为止，我们的 form 组件大致的实现逻辑就已经完成了，后续需要支持新的功能，也可以通过定义新的 prop 来完善</p> <h2 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h2> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-form</span>
    <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>formRef<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>state<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:rules</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{
      username: {
        min: 6,
        max: 10,
        message: <span class="token punctuation">'</span>用户名6-10位<span class="token punctuation">'</span>,
        trigger: [<span class="token punctuation">'</span>change<span class="token punctuation">'</span>, <span class="token punctuation">'</span>blur<span class="token punctuation">'</span>],
      },
    }<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-form-item</span>
      <span class="token attr-name">prop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>用户名<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:rules</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[{ required: true, message: <span class="token punctuation">'</span>请输入用户名<span class="token punctuation">'</span>, trigger: <span class="token punctuation">'</span>blur<span class="token punctuation">'</span> }]<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-input</span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入用户名<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>state.username<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-form-item</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-form-item</span>
      <span class="token attr-name">prop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">label</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>密码<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:rules</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[{ required: true, message: <span class="token punctuation">'</span>请输入密码<span class="token punctuation">'</span>, trigger: <span class="token punctuation">'</span>blur<span class="token punctuation">'</span> }]<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-input</span>
        <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>请输入密码<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>state.password<span class="token punctuation">&quot;</span></span>
        <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span>
      <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-form-item</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>el-button</span> <span class="token attr-name">size</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>medium<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:round</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>validateForm<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      按钮
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>el-button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-form</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;vue&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormInstance <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@/components/form&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> formRef <span class="token operator">=</span> ref<span class="token operator">&lt;</span>FormInstance<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">validateForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> form <span class="token operator">=</span> formRef<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  form<span class="token operator">?.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">valid<span class="token punctuation">,</span> errors</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>valid<span class="token punctuation">,</span> errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div><div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/React/React18.html" class="prev">
        React18
      </a></span> <span class="next"><a href="/Vue/搭建vue3和ts组件库开发环境.html">
        搭建vue3和ts组件库开发环境
      </a>
      →
    </span></p></div> <div class="icp-footer"><p>Copyright© 2022-2023 _妄想何方</p> <a href="https://beian.miit.gov.cn/" target="_blank">蜀ICP备2022010321号-1</a></div></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.126f0258.js" defer></script><script src="/assets/js/2.30bd822f.js" defer></script><script src="/assets/js/15.11062623.js" defer></script><script src="/assets/js/11.b85d9fb6.js" defer></script>
  </body>
</html>

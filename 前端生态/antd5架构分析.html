<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>antd5 介绍 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="前端技术相关的文章，包含不限于vue，react，webpack，nodejs，算法等等">
    
    <link rel="preload" href="/assets/css/0.styles.1bd58bef.css" as="style"><link rel="preload" href="/assets/js/app.a5e2a326.js" as="script"><link rel="preload" href="/assets/js/2.a6634917.js" as="script"><link rel="preload" href="/assets/js/7.5b3397e2.js" as="script"><link rel="preload" href="/assets/js/11.8af1e3cd.js" as="script"><link rel="prefetch" href="/assets/js/10.d3f689f8.js"><link rel="prefetch" href="/assets/js/12.ed1e11ae.js"><link rel="prefetch" href="/assets/js/13.e0a441de.js"><link rel="prefetch" href="/assets/js/14.9e318840.js"><link rel="prefetch" href="/assets/js/15.d841da4f.js"><link rel="prefetch" href="/assets/js/16.34930d07.js"><link rel="prefetch" href="/assets/js/17.07cd49aa.js"><link rel="prefetch" href="/assets/js/18.39517720.js"><link rel="prefetch" href="/assets/js/19.1f1689c7.js"><link rel="prefetch" href="/assets/js/20.84a7ddf3.js"><link rel="prefetch" href="/assets/js/21.d47f1b28.js"><link rel="prefetch" href="/assets/js/22.3f16cfa0.js"><link rel="prefetch" href="/assets/js/23.f86859e1.js"><link rel="prefetch" href="/assets/js/24.b73b4835.js"><link rel="prefetch" href="/assets/js/25.d3f53bc9.js"><link rel="prefetch" href="/assets/js/26.ee307239.js"><link rel="prefetch" href="/assets/js/27.eaad36cd.js"><link rel="prefetch" href="/assets/js/28.2ea9696e.js"><link rel="prefetch" href="/assets/js/29.0f3fa806.js"><link rel="prefetch" href="/assets/js/3.c79fccf9.js"><link rel="prefetch" href="/assets/js/30.9a0696b4.js"><link rel="prefetch" href="/assets/js/31.89a9820d.js"><link rel="prefetch" href="/assets/js/32.dba916d1.js"><link rel="prefetch" href="/assets/js/33.4c1838f9.js"><link rel="prefetch" href="/assets/js/34.968a05eb.js"><link rel="prefetch" href="/assets/js/35.88ee813d.js"><link rel="prefetch" href="/assets/js/36.ec349609.js"><link rel="prefetch" href="/assets/js/37.7f17ec10.js"><link rel="prefetch" href="/assets/js/38.1844a26b.js"><link rel="prefetch" href="/assets/js/39.3f1bd3ec.js"><link rel="prefetch" href="/assets/js/4.baf3274c.js"><link rel="prefetch" href="/assets/js/40.e03e4557.js"><link rel="prefetch" href="/assets/js/41.a69c6022.js"><link rel="prefetch" href="/assets/js/42.705f89ae.js"><link rel="prefetch" href="/assets/js/43.9fb62012.js"><link rel="prefetch" href="/assets/js/5.f40b1275.js"><link rel="prefetch" href="/assets/js/6.4eaec7b1.js"><link rel="prefetch" href="/assets/js/8.7c035891.js"><link rel="prefetch" href="/assets/js/9.0f0a6fdc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1bd58bef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/doc-front-end" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/doc-front-end" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">主页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/JavaScript/小顶堆.html" class="sidebar-link">小顶堆</a></li><li><a href="/JavaScript/位运算.html" class="sidebar-link">位运算</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>React Fiber</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/React-Fiber/React理念.html" class="sidebar-link">React理念</a></li><li><a href="/React/React-Fiber/ReactFiber架构.html" class="sidebar-link">Fiber架构</a></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>React Fiber Render</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/React-Fiber/Fiber-dom-diff/beginWork.html" class="sidebar-link">beginWork阶段</a></li><li><a href="/React/React-Fiber/Fiber-dom-diff/completeWork.html" class="sidebar-link">completeWork阶段</a></li><li><a href="/React/React-Fiber/Fiber-dom-diff/commit.html" class="sidebar-link">commit阶段</a></li><li><a href="/React/React-Fiber/Fiber-dom-diff/domdiff.html" class="sidebar-link">completeWork-diff阶段</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>Concurrent Mode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/React/Concurrent-Mode/React中的事件优先级调度.html" class="sidebar-link">React事件优先级调度</a></li><li><a href="/React/Concurrent-Mode/scheduler.html" class="sidebar-link">scheduler具体实现</a></li><li><a href="/React/Concurrent-Mode/lane.html" class="sidebar-link">lane模型</a></li></ul></section></li><li><a href="/React/React17.html" class="sidebar-link">React17</a></li><li><a href="/React/React18.html" class="sidebar-link">React18</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Vue/Vue3+Typescript实现Form组件.html" class="sidebar-link">Vue3+Typescript实现Form组件</a></li><li><a href="/Vue/搭建vue3和ts组件库开发环境.html" class="sidebar-link">搭建vue3和ts组件库开发环境</a></li><li><a href="/Vue/Vite2配置项目开发环境.html" class="sidebar-link">Vite2配置项目开发环境</a></li><li><a href="/Vue/基于Element-plus实现虚拟下拉组件.html" class="sidebar-link">基于Element-plus实现虚拟下拉组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端生态</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/前端生态/eslint.html" class="sidebar-link">eslint</a></li><li><a href="/前端生态/flutter实践.html" class="sidebar-link">flutter实践</a></li><li><a href="/前端生态/flutter消息推送.html" class="sidebar-link">flutter消息推送</a></li><li><a href="/前端生态/antd5架构分析.html" class="active sidebar-link">antd5研究</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#antd5-介绍" class="sidebar-link">antd5 介绍</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#目录结构" class="sidebar-link">目录结构</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#组件编写" class="sidebar-link">组件编写</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#主题样式设计" class="sidebar-link">主题样式设计</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#组件库文档设计" class="sidebar-link">组件库文档设计</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#组件库打包" class="sidebar-link">组件库打包</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#组件库单元测试" class="sidebar-link">组件库单元测试</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#ts-node" class="sidebar-link">ts-node</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#pre-publish-的一些检查" class="sidebar-link">pre-publish 的一些检查</a></li><li class="sidebar-sub-header"><a href="/前端生态/antd5架构分析.html#按需加载" class="sidebar-link">按需加载</a></li></ul></li><li><a href="/前端生态/element-plus架构分析.html" class="sidebar-link">element-plus样式+打包分析</a></li><li><a href="/前端生态/ts类型打包.html" class="sidebar-link">ts类型打包</a></li><li><a href="/前端生态/vscode扩展工具.html" class="sidebar-link">vscode扩展工具实现</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>go</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/go/mac如何安装grpc.html" class="sidebar-link">mac安装grpc</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="antd5-介绍"><a href="#antd5-介绍" class="header-anchor">#</a> antd5 介绍</h2> <p>Ant Design of React 是阿里推出的一款开箱即用的高质量组件库，可以帮助我们平时的快速开发，它有如下特点：</p> <ul><li>🌈 提炼自企业级中后台产品的交互语言和视觉风格。</li> <li>📦 开箱即用的高质量 React 组件。</li> <li>🛡 使用 TypeScript 开发，提供完整的类型定义文件。</li> <li>⚙️ 全链路开发和设计工具体系。</li> <li>🌍 数十个国际化语言支持。</li> <li>🎨 深入每个细节的主题定制能力。</li></ul> <p><code>antd5</code> 整个框架文档架构是用<a href="https://d.umijs.org/guide" target="_blank" rel="noopener noreferrer">dump<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来做的， 今天我们主要针对其中的几个点来学习和分析一下项目的架构实现</p> <h2 id="目录结构"><a href="#目录结构" class="header-anchor">#</a> 目录结构</h2> <div class="language-shell extra-class"><pre class="language-shell"><code>
antd

├── locale 语言文件
├── doc 一些博客文章文章之类的
├── components
     └── 组件
          ├── <span class="token builtin class-name">test</span> 单元测试文件
          ├── demo 一些demo文件，主要用在组件库文档里面，会通过 antd内置的 code标签插入进来
          ├── .md文档 组件的文档
          ├── style  组件的样式文件 cssinjs
          └── index.tsx 入口文件
          └── main.dart
├── script 一些脚本命令文件
├── typings 一些类型声明文件
└── tests 单元测试文件
</code></pre></div><h2 id="组件编写"><a href="#组件编写" class="header-anchor">#</a> 组件编写</h2> <p>我们以 <code>Button</code>组件为例来分析一下 <code>antd</code>的组件编写方式和规范</p> <p>1、在 <code>index.ts</code> 文件中我们需要导出每一个组件的类型和改组件
例如：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> Button <span class="token keyword">from</span> <span class="token string">'./button'</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> SizeType <span class="token keyword">as</span> ButtonSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../config-provider/SizeContext'</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ButtonProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./button'</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ButtonGroupProps <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./button-group'</span>

<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./buttonHelpers'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Button
</code></pre></div><p>2、然后我们去看看 <code>Button.tsx</code>中的一些功能实现</p> <p>在每一个组件文件的前面会定义组件中的一些类型，比如：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//摘自 Button.tsx</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">BaseButtonProps</span> <span class="token punctuation">{</span>
  type<span class="token operator">?</span><span class="token operator">:</span> ButtonType
  icon<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode
  shape<span class="token operator">?</span><span class="token operator">:</span> ButtonShape
  size<span class="token operator">?</span><span class="token operator">:</span> SizeType
  disabled<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  loading<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token punctuation">{</span> delay<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span>
  prefixCls<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  className<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  rootClassName<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  ghost<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  danger<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  block<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  children<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">NativeButtonProps</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  htmlType<span class="token operator">?</span><span class="token operator">:</span> ButtonHTMLType
  onClick<span class="token operator">?</span><span class="token operator">:</span> React<span class="token punctuation">.</span>MouseEventHandler<span class="token operator">&lt;</span>HTMLButtonElement<span class="token operator">&gt;</span>
<span class="token punctuation">}</span> <span class="token operator">&amp;</span> BaseButtonProps <span class="token operator">&amp;</span>
  Omit<span class="token operator">&lt;</span>React<span class="token punctuation">.</span>ButtonHTMLAttributes<span class="token operator">&lt;</span>HTMLButtonElement<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token string">'type'</span> <span class="token operator">|</span> <span class="token string">'onClick'</span><span class="token operator">&gt;</span>

<span class="token comment">//导出button的props类型</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ButtonProps</span> <span class="token operator">=</span> Partial<span class="token operator">&lt;</span>AnchorButtonProps <span class="token operator">&amp;</span> NativeButtonProps<span class="token operator">&gt;</span>
</code></pre></div><p>定义组件的样式类名：
在 antd 组件中，每一个组件会调用一个方法<code>defaultGetPrefixCls</code>来定义自己组件类名的前缀</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">//context.ts 文件</span>
<span class="token keyword">const</span> <span class="token function-variable function">defaultGetPrefixCls</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  suffixCls<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  customizePrefixCls<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>customizePrefixCls<span class="token punctuation">)</span> <span class="token keyword">return</span> customizePrefixCls

  <span class="token keyword">return</span> suffixCls <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ant-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>suffixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">'ant'</span>
<span class="token punctuation">}</span>

<span class="token comment">//在button.tsx中 定义类名前缀，此处给的前缀是 btn，所以结合上面的函数 Button组件的样式类名前缀就是 ant-btn</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getPrefixCls <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span>
<span class="token keyword">const</span> prefixCls <span class="token operator">=</span> <span class="token function">getPrefixCls</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">,</span> customizePrefixCls<span class="token punctuation">)</span>
</code></pre></div><p><code>antd</code> 使用 <code>classnames</code>库来一次性给组件绑定多个类， <code>classnames</code>库相比于我们之前的那种给组件绑定多个 class 的写法会更加的简单和便利，例如：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token function">classnames</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-property property">'class1'</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">'class2'</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'foo bar'</span>
<span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'foo bar'</span>
<span class="token function">classNames</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">'foo-bar'</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'foo-bar'</span>
<span class="token function">classNames</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">'foo-bar'</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; ''</span>
<span class="token function">classNames</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'foo bar'</span>
<span class="token function">classNames</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// =&gt; 'foo bar'</span>
</code></pre></div><p>最后组件在渲染的时候会去走一个 <code>wrapSSr</code>的方法，这个方法由<code>useStyle</code>生成</p> <div class="language-ts extra-class"><pre class="language-ts"><code>  <span class="token keyword">const</span> <span class="token punctuation">[</span>wrapSSR<span class="token punctuation">,</span> hashId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useStyle</span><span class="token punctuation">(</span>prefixCls<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token function">wrapSSR</span><span class="token punctuation">(</span>buttonNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>首先在组件内的<code>useStyle</code>传入了<code>warpSSR和hashID</code>，执行<code>genComponentStyleHook</code>，最终返回<code>useStyleRegister</code>这个函数并传入<code>styleFn</code>，核心执行<code>useGlobalCache</code>函数，<code>styleFn</code>执行时组件本身的样式和被合并的<code>token</code>就被加载到一个<code>StyleObj</code>对象上了,最后渲染出来</p> <p>在 <code>wrapSSR</code> 方法中，</p> <h2 id="主题样式设计"><a href="#主题样式设计" class="header-anchor">#</a> 主题样式设计</h2> <p>首先，当我们想要设置或者修改<code>antd</code>的默认主题的时候，按照官方的写法，我们需要在我们想要覆盖默认主题的外层包一个 <code>ConfigProvider</code>,例如：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Button <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ConfigProvider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'antd'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> theme <span class="token operator">=</span> <span class="token punctuation">{</span>
    token<span class="token operator">:</span> <span class="token punctuation">{</span>
      colorPrimary<span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>
      colorError<span class="token operator">:</span> <span class="token string">'#ff4d4f'</span><span class="token punctuation">,</span>
      colorWarning<span class="token operator">:</span> <span class="token string">'#ffc245'</span><span class="token punctuation">,</span>
      colorSuccess<span class="token operator">:</span> <span class="token string">'#00c48c'</span><span class="token punctuation">,</span>
      colorText<span class="token operator">:</span> <span class="token string">'#3c4761'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* 传入theme属性，覆盖默认主题 */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigProvider</span></span> <span class="token attr-name">theme</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>theme<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Button</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">点击</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Button</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ConfigProvider</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么在 antd 组件内部是怎么实现的，可以通过这个 <code>ConfigProvider</code>来修改默认样式，下面我们一起去看看：</p> <p>我们还是以<code>Button</code> 组件为例</p> <p>1、首先在<code>button</code>组件中会去获取上下文中的属性</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 使用 getPrefixCls 生成一个前缀class类名 ，比如 ant-btn</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getPrefixCls <span class="token punctuation">}</span> <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span>
<span class="token keyword">const</span> prefixCls <span class="token operator">=</span> <span class="token function">getPrefixCls</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">,</span> customizePrefixCls<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'prefixCls:'</span><span class="token punctuation">,</span> prefixCls<span class="token punctuation">)</span> <span class="token comment">//ant-btn</span>
</code></pre></div><img src="/assets/img/prefix.c2ee9481.png" alt="center"> <p>2、然后 回从 <code>useStyle</code> 中获取 <code>wrapSSR</code> 方法 和 一个 <code>hashId</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>wrapSSR<span class="token punctuation">,</span> hashId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useStyle</span><span class="token punctuation">(</span>prefixCls<span class="token punctuation">)</span>
</code></pre></div><p><code>useStyle</code> 就等于下面的直接执行函数<code>genComponentStyleHook</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">genComponentStyleHook</span><span class="token punctuation">(</span><span class="token string">'Button'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> controlTmpOutline<span class="token punctuation">,</span> paddingContentHorizontal <span class="token punctuation">}</span> <span class="token operator">=</span> token
  <span class="token comment">//buttonToken 中就包含了一些样式变量，比如 color，fontSize等</span>
  <span class="token keyword">const</span> buttonToken <span class="token operator">=</span> <span class="token generic-function"><span class="token function">mergeToken</span><span class="token generic class-name"><span class="token operator">&lt;</span>ButtonToken<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    colorOutlineDefault<span class="token operator">:</span> controlTmpOutline<span class="token punctuation">,</span>
    buttonPaddingHorizontal<span class="token operator">:</span> paddingContentHorizontal<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 往token中合并新的css变量</span>
    <span class="token comment">// Shared  共享的变量 ，比如   outline: 'none', position: 'relative',</span>
    <span class="token function">genSharedButtonStyle</span><span class="token punctuation">(</span>buttonToken<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// Size 尺寸相关的css变量 比如padding</span>
    <span class="token function">genSizeSmallButtonStyle</span><span class="token punctuation">(</span>buttonToken<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">genSizeBaseButtonStyle</span><span class="token punctuation">(</span>buttonToken<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">genSizeLargeButtonStyle</span><span class="token punctuation">(</span>buttonToken<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// Block</span>
    <span class="token comment">// 设置块元素样式 width:100%</span>
    <span class="token function">genBlockButtonStyle</span><span class="token punctuation">(</span>buttonToken<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// Group (type, ghost, danger, disabled, loading)</span>
    <span class="token comment">// 设置不同type的button的颜色， [`${componentCls}-default`]: genDefaultButtonStyle(token),</span>
    <span class="token function">genTypeButtonStyle</span><span class="token punctuation">(</span>buttonToken<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// Button Group</span>
    <span class="token comment">// 按钮组相关样式</span>
    <span class="token function">genGroupStyle</span><span class="token punctuation">(</span>buttonToken<span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// Space Compact</span>
    <span class="token function">genCompactItemStyle</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{</span> focus<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">genCompactItemVerticalStyle</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><img src="/assets/img/token.7ff69dbb.png" alt="center"> <img src="/assets/img/tokenInfo.0deabf4d.png" alt="center"> <p>3、在 <code>genComponentStyleHook</code> 方法中 调用了 <code>@ant-design/cssinjs</code> 中的 <code>useStyleRegister</code> 方法，用于生成 <code>wrapSSR, hashId</code> 这两个东西</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">genComponentStyleHook</span><span class="token generic class-name"><span class="token operator">&lt;</span>
  ComponentName <span class="token keyword">extends</span> OverrideComponent
<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
  component<span class="token operator">:</span> ComponentName<span class="token punctuation">,</span> <span class="token comment">//组件名字</span>
  <span class="token function-variable function">styleFn</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    token<span class="token operator">:</span> FullToken<span class="token operator">&lt;</span>ComponentName<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    info<span class="token operator">:</span> StyleInfo<span class="token operator">&lt;</span>ComponentName<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> CSSInterpolation<span class="token punctuation">,</span>
  getDefaultToken<span class="token operator">?</span><span class="token operator">:</span>
    <span class="token operator">|</span> OverrideTokenWithoutDerivative<span class="token punctuation">[</span>ComponentName<span class="token punctuation">]</span>
    <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>token<span class="token operator">:</span> GlobalToken<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OverrideTokenWithoutDerivative<span class="token punctuation">[</span>ComponentName<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>prefixCls<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> UseComponentStyleResult <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>theme<span class="token punctuation">,</span> token<span class="token punctuation">,</span> hashId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> getPrefixCls<span class="token punctuation">,</span> iconPrefixCls <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useContext</span><span class="token punctuation">(</span>ConfigContext<span class="token punctuation">)</span>
    <span class="token keyword">const</span> rootPrefixCls <span class="token operator">=</span> <span class="token function">getPrefixCls</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// Generate style for all a tags in antd component.</span>
    <span class="token function">useStyleRegister</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span> theme<span class="token punctuation">,</span> token<span class="token punctuation">,</span> hashId<span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Shared'</span><span class="token punctuation">,</span> rootPrefixCls<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token comment">// Link</span>
          <span class="token string-property property">'&amp;'</span><span class="token operator">:</span> <span class="token function">genLinkStyle</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 此处返回了 wrapSSR, hashId</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token function">useStyleRegister</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span> theme<span class="token punctuation">,</span> token<span class="token punctuation">,</span> hashId<span class="token punctuation">,</span> path<span class="token operator">:</span> <span class="token punctuation">[</span>component<span class="token punctuation">,</span> prefixCls<span class="token punctuation">,</span> iconPrefixCls<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// ...省略</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      hashId<span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们其实可以看到 <code>genComponentStyleHook</code> 这个函数里面主要就是调用了 <code>@ant-design/cssinjs</code> 中的 <code>useStyleRegister</code> 方法，下面我们来看看这个方法中都做了什么处理</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Register a style to the global style sheet.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">useStyleRegister</span><span class="token punctuation">(</span><span class="token parameter">info<span class="token punctuation">,</span> styleFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...省略</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> styleNode
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ssrInline <span class="token operator">||</span> isMergedClientSide <span class="token operator">||</span> <span class="token operator">!</span>defaultCache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      styleNode <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Empty<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> _ref4
      styleNode <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
        <span class="token string">'style'</span><span class="token punctuation">,</span>
        <span class="token function">_extends</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>_ref4 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">_defineProperty</span><span class="token punctuation">(</span>_ref4<span class="token punctuation">,</span> <span class="token constant">ATTR_TOKEN</span><span class="token punctuation">,</span> cachedTokenKey<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">_defineProperty</span><span class="token punctuation">(</span>_ref4<span class="token punctuation">,</span> <span class="token constant">ATTR_MARK</span><span class="token punctuation">,</span> cachedStyleId<span class="token punctuation">)</span><span class="token punctuation">,</span>
          _ref4<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">dangerouslySetInnerHTML</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">__html</span><span class="token operator">:</span> cachedStyleStr<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token comment">/*#__PURE__*/</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
      React<span class="token punctuation">.</span>Fragment<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      styleNode<span class="token punctuation">,</span>
      node
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们其实可以看到<code>useStyleRegister</code> 的大致逻辑就是</p> <ul><li>注册一个<code>style</code>标签插入到<code>header</code>中，并将处理好了样式字符串 插入到生成的<code>style</code>标签中去</li> <li>最后会使用<code>React.createElement</code> 去渲染我们 <code>wrapSSR</code> 方法中传入的 <code>node</code> 节点，此处指的就是 <code>button</code> 按钮</li></ul> <p>最后 <code>antd</code>中会使用 <code>classnames</code>组合多个 <code>class</code> 类名 ，并传递给 <code>button</code> 组件</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> classes <span class="token operator">=</span> <span class="token function">classNames</span><span class="token punctuation">(</span>
  prefixCls<span class="token punctuation">,</span>
  hashId<span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>shape<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> shape <span class="token operator">!==</span> <span class="token string">'default'</span> <span class="token operator">&amp;&amp;</span> shape<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">type</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> type<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sizeCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> sizeCls<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-icon-only</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token operator">!</span>children <span class="token operator">&amp;&amp;</span> children <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>iconType<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-background-ghost</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> ghost <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isUnBorderedButtonType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-loading</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> innerLoading<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-two-chinese-chars</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span>
      hasTwoCNChar <span class="token operator">&amp;&amp;</span> autoInsertSpace <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>innerLoading<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-block</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> block<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-dangerous</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>danger<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-rtl</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> direction <span class="token operator">===</span> <span class="token string">'rtl'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefixCls<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-disabled</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token operator">:</span> hrefAndDisabled<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  compactItemClassnames<span class="token punctuation">,</span>
  className<span class="token punctuation">,</span>
  rootClassName
<span class="token punctuation">)</span>

<span class="token keyword">let</span> buttonNode <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token operator">&lt;</span>button
    <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">(</span>rest <span class="token keyword">as</span> NativeButtonProps<span class="token punctuation">)</span><span class="token punctuation">}</span>
    type<span class="token operator">=</span><span class="token punctuation">{</span>htmlType<span class="token punctuation">}</span>
    className<span class="token operator">=</span><span class="token punctuation">{</span>classes<span class="token punctuation">}</span> <span class="token comment">// 类名集合</span>
    onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span>
    disabled<span class="token operator">=</span><span class="token punctuation">{</span>mergedDisabled<span class="token punctuation">}</span>
    ref<span class="token operator">=</span><span class="token punctuation">{</span>buttonRef<span class="token punctuation">}</span>
  <span class="token operator">&gt;</span>
    <span class="token punctuation">{</span>iconNode<span class="token punctuation">}</span>
    <span class="token punctuation">{</span>kids<span class="token punctuation">}</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
<span class="token punctuation">)</span>

<span class="token comment">//wrapSSR由 useStyleRegister 方法返回</span>
<span class="token keyword">return</span> <span class="token function">wrapSSR</span><span class="token punctuation">(</span>buttonNode<span class="token punctuation">)</span>
</code></pre></div><p>总结：</p> <p>首先在组件内的 <code>useStyle</code> 传入了 <code>warpSSR</code> 和 <code>hashID</code> ，执行 <code>genComponentStyleHook</code> ，最终返回 <code>useStyleRegister</code> 这个函数并传入 <code>styleFn，useStyleRegister</code> 最后会返回一个函数，该函数会去渲染我们包裹的组件，比如 <code>button，</code>而且还会将一些样式通过创建
<code>style</code> 标签的方式插入到 <code>header</code> 中。在<code>@ant-design/cssinjs</code>内部和 ·antd· 中有一套自己的基本主题，定义了一些基本的样式变量，每一个组件通过 <code>configProvider</code> 可以拿到具体的属性样式，从而覆盖设置每一个组件的样式</p> <h2 id="组件库文档设计"><a href="#组件库文档设计" class="header-anchor">#</a> 组件库文档设计</h2> <p><code>antd5</code> 整个框架文档架构是用<a href="https://d.umijs.org/guide" target="_blank" rel="noopener noreferrer">dump<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来做的，项目中如果你想在 <code>markdown</code>文档里面引入<code>react</code>组件的话，只需要如下所示：</p> <div class="language-md extra-class"><pre class="language-md"><code><span class="token comment">&lt;!-- 标识这个example下面的就是代码 --&gt;</span>

<span class="token title important"><span class="token punctuation">##</span> Examples</span>

<span class="token comment">&lt;!-- prettier-ignore --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./demo/basic.tsx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Basic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./demo/on-change.tsx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Callback<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./demo/target.tsx<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Container to scroll.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./demo/debug.tsx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">debug</span><span class="token punctuation">&gt;</span></span>debug<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>此处的处理应该是 <code>dump</code> 内部实现了一个 <code>markdown</code> 的插件 ,该插件会去解析 <code>markdown</code>，如果发现有 <code>## Examples</code> 的标识就回去解析它下面的代码 ，把他集成到一个自己内部实现的 <code>react</code> 环境中 去渲染</p> <p>感兴趣的可以自己了解一下 <code>dump</code> 的内部实现</p> <h2 id="组件库打包"><a href="#组件库打包" class="header-anchor">#</a> 组件库打包</h2> <p>在<code>antd</code>的<code>package.json</code>文件中，有这么一段打包命令</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run compile &amp;&amp; cross-env  NODE_OPTIONS='--max-old-space-size=4096' npm run dist&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;clean&quot;</span><span class="token operator">:</span> <span class="token string">&quot;antd-tools run clean &amp;&amp; rm -rf es lib coverage dist report.html&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;compile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run clean &amp;&amp; antd-tools run compile&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dist&quot;</span><span class="token operator">:</span> <span class="token string">&quot;antd-tools run dist&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当我们执行 <code>npm run build</code>命令的时候，他会先去执行 <code>npm run compile</code>命令将组件库编译到<code>lib和es</code>目录下面，然后通过 <code>cross-env NODE_OPTIONS='--max-old-space-size=4096'</code>指令可以设置运行后面的 <code>npm run dist</code>命令的时候，系统给 node 分配的内存大小，因为默认 node 在一些 64 位计算机中运行的时候，默认分配的内存使用最大不会超过 <code>2G</code></p> <p>接下来我们来具体看看每一个<code>npm run compile</code> 和 <code>npm run dist</code>命令都是干了什么</p> <p><code>npm run compile</code>:
执行这个命令的时候我们可以看到先执行<code>npm run clean</code>这个命令删除了一些历史的打包文件之类的，然后主要执行的是 <code>antd-tools run compile</code> 这个命令 ，<code>antd-tools</code>是 <code>@ant-design</code> 库中的一个工具，我们可以在这儿看到
<img src="/assets/img/antd-tools.c0e31ec0.png" alt="center"></p> <p>首先，他会去执行<code>node_modules\@ant-design\tools\lib\cli\index.js</code> 目录下面的文件，文件的内容如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token hashbang comment">#!/usr/bin/env node</span>

<span class="token string">'use strict'</span>

<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> gulp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'gulp'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> argv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'minimist'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> cloneArgs <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>argv <span class="token punctuation">}</span>
<span class="token keyword">delete</span> cloneArgs<span class="token punctuation">.</span>_

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token string">'Execute:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  chalk<span class="token punctuation">.</span><span class="token function">green</span><span class="token punctuation">(</span>argv<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">'-'</span><span class="token punctuation">,</span>
  <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cloneArgs<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'  - Args:'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>cloneArgs<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../gulpfile'</span><span class="token punctuation">)</span>

<span class="token comment">// Start glup task</span>
<span class="token keyword">function</span> <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token parameter">toRun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> metadata <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">task</span><span class="token operator">:</span> toRun <span class="token punctuation">}</span>
  <span class="token comment">// Gulp &gt;= 4.0.0 (doesn't support events)</span>
  <span class="token keyword">const</span> taskInstance <span class="token operator">=</span> gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span>toRun<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>taskInstance <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gulp<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'task_not_found'</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">hrtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  gulp<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'task_start'</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//执行task任务</span>
    <span class="token function">taskInstance</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>gulp<span class="token punctuation">)</span>
    metadata<span class="token punctuation">.</span>hrDuration <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">hrtime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
    <span class="token comment">//触发任务</span>
    gulp<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'task_stop'</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span>
    gulp<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    err<span class="token punctuation">.</span>hrDuration <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">hrtime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
    err<span class="token punctuation">.</span>task <span class="token operator">=</span> metadata<span class="token punctuation">.</span>task
    gulp<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'task_err'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//执行方法,获取到命令参数，比如 npm run compile 的 compile</span>
<span class="token function">runTask</span><span class="token punctuation">(</span>argv<span class="token punctuation">.</span>_<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>当执行到 <code>compile</code>命令的时候，主要会去执行 <code>gulpfile</code>中的 <code>compile</code> 任务,内容如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//使用babel转化js</span>
<span class="token keyword">function</span> <span class="token function">babelify</span><span class="token punctuation">(</span><span class="token parameter">js<span class="token punctuation">,</span> modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> babelConfig <span class="token operator">=</span> <span class="token function">getBabelCommonConfig</span><span class="token punctuation">(</span>modules<span class="token punctuation">)</span> <span class="token comment">//获取到babel配置</span>
  <span class="token keyword">delete</span> babelConfig<span class="token punctuation">.</span>cacheDirectory
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modules <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//自定义了一个babel插件，用于替代将项目中引用lib下面的路径转化为es的模块路径</span>
    babelConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>replaceLib<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> js<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">babel</span><span class="token punctuation">(</span>babelConfig<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">//输出到制定目录</span>
  <span class="token keyword">return</span> stream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span>modules <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> esDir <span class="token operator">:</span> libDir<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">compile</span><span class="token operator">:</span> <span class="token punctuation">{</span> transformTSFile<span class="token punctuation">,</span> transformFile <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>modules <span class="token operator">!==</span> <span class="token boolean">false</span> <span class="token operator">?</span> libDir <span class="token operator">:</span> esDir<span class="token punctuation">)</span> <span class="token comment">//module如果是true的话，就删除lib文件夹，否则删除es文件夹</span>

  <span class="token comment">//将components目录下面的所有子目录中的 png 和 svg 文件拷贝到lib或者es</span>
  <span class="token keyword">const</span> assets <span class="token operator">=</span> gulp
    <span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'components/**/*.@(png|svg)'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span>modules <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> esDir <span class="token operator">:</span> libDir<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> error <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token comment">// =============================== FILE ===============================</span>
  <span class="token keyword">let</span> transformFileStream

  <span class="token keyword">if</span> <span class="token punctuation">(</span>transformFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    transformFileStream <span class="token operator">=</span> gulp
      <span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'components/**/*.tsx'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
        through2<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> nextFile <span class="token operator">=</span> <span class="token function">transformFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> file
          nextFile <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>nextFile<span class="token punctuation">)</span> <span class="token operator">?</span> nextFile <span class="token operator">:</span> <span class="token punctuation">[</span>nextFile<span class="token punctuation">]</span>
          nextFile<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span>modules <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> esDir <span class="token operator">:</span> libDir<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ================================ TS ================================</span>
  <span class="token comment">//文件匹配规则</span>
  <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'components/**/*.tsx'</span><span class="token punctuation">,</span>
    <span class="token string">'components/**/*.ts'</span><span class="token punctuation">,</span>
    <span class="token string">'typings/**/*.d.ts'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/**/__tests__/**'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/**/demo/**'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/**/design/**'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  <span class="token comment">// allow jsx file in components/xxx/</span>
  <span class="token comment">//是够允许js文件，允许的话就往数组前面加上对jsx文件的匹配规则</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tsConfig<span class="token punctuation">.</span>allowJs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    source<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token string">'components/**/*.jsx'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Strip content if needed</span>
  <span class="token comment">// gulp.src() 方法根据文件匹配规则获取源文件的读取流（source stream）</span>
  <span class="token comment">// 通过获取源文件的读取流，后续的构建任务可以使用这个流来读取和处理源文件，生成最终的构建产物。</span>
  <span class="token keyword">let</span> sourceStream <span class="token operator">=</span> gulp<span class="token punctuation">.</span><span class="token function">src</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modules <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果编译es， 使用 stripCode 插件来删除源代码中的特定注释段落。</span>
    <span class="token comment">//删除 start_comment 和 end_comment 之间的所有代码</span>
    sourceStream <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      <span class="token function">stripCode</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">start_comment</span><span class="token operator">:</span> <span class="token string">'@remove-on-es-build-begin'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">end_comment</span><span class="token operator">:</span> <span class="token string">'@remove-on-es-build-end'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>transformTSFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sourceStream <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
      through2<span class="token punctuation">.</span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> nextFile <span class="token operator">=</span> <span class="token function">transformTSFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> file
        nextFile <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>nextFile<span class="token punctuation">)</span> <span class="token operator">?</span> nextFile <span class="token operator">:</span> <span class="token punctuation">[</span>nextFile<span class="token punctuation">]</span>
        nextFile<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//使用ts插件编译文件中的ts代码，生成对应的类型申明文件 .d.ts结尾</span>
  <span class="token keyword">const</span> tsResult <span class="token operator">=</span> sourceStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">ts</span><span class="token punctuation">(</span>tsConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        tsDefaultReporter<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        error <span class="token operator">=</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">finish</span><span class="token operator">:</span> tsDefaultReporter<span class="token punctuation">.</span>finish<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>argv<span class="token punctuation">[</span><span class="token string">'ignore-error'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  tsResult<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> check<span class="token punctuation">)</span>
  tsResult<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> check<span class="token punctuation">)</span>
  <span class="token keyword">const</span> tsFilesStream <span class="token operator">=</span> <span class="token function">babelify</span><span class="token punctuation">(</span>tsResult<span class="token punctuation">.</span>js<span class="token punctuation">,</span> modules<span class="token punctuation">)</span>
  <span class="token comment">//输出到指定目录</span>
  <span class="token keyword">const</span> tsd <span class="token operator">=</span> tsResult<span class="token punctuation">.</span>dts<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>gulp<span class="token punctuation">.</span><span class="token function">dest</span><span class="token punctuation">(</span>modules <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> esDir <span class="token operator">:</span> libDir<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">//合并多个文件操作流</span>
  <span class="token keyword">return</span> <span class="token function">merge2</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>tsFilesStream<span class="token punctuation">,</span> tsd<span class="token punctuation">,</span> assets<span class="token punctuation">,</span> transformFileStream<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'compile-with-es'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Parallel] Compile to es...'</span><span class="token punctuation">)</span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> done<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'compile-with-lib'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Parallel] Compile to js...'</span><span class="token punctuation">)</span>
  <span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">generateLocale</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span><span class="token string">'compile-finalize'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Additional process of compile finalize</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">compile</span><span class="token operator">:</span> <span class="token punctuation">{</span> finalize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>finalize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Compile] Finalization...'</span><span class="token punctuation">)</span>
    <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span>
  <span class="token string">'compile'</span><span class="token punctuation">,</span>
  gulp<span class="token punctuation">.</span><span class="token function">series</span><span class="token punctuation">(</span>
    gulp<span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token string">'compile-with-es'</span><span class="token punctuation">,</span> <span class="token string">'compile-with-lib'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'compile-finalize'</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>注意点：</p> <p>1、其中有一个 <code>getBabelCommonConfig</code> 方法去获取<code>babel</code>配置，我们来看看这个文件的配置是什么以及怎么配置的，具体内容如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
  resolve<span class="token punctuation">,</span>
  isThereHaveBrowserslistConfig<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/projectHelper'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token comment">//用于将TypeScript代码转换为JavaScript代码</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/plugin-transform-typescript'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">isTSX</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token comment">//提供了一种在编译ES6+代码时使用babel-runtime来避免重复注入帮助程序的方式。</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token comment">/**译器将生成 ES6 模块的代码，这意味着您可以使用 import/export 语法来导入/导出模块。
         * 如果 useESModules 被设置为 false，则编译器将生成 CommonJS 模块的代码，
         * 这意味着您可以使用 require/module.exports
         * 语法来导入/导出模块。默认情况下，Babel 7+ 会将 useESModules 设置为 false， */</span>
        <span class="token literal-property property">useESModules</span><span class="token operator">:</span> modules <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">version</span><span class="token operator">:</span>
          <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/package.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span>dependencies<span class="token punctuation">[</span>
            <span class="token string">'@babel/runtime'</span>
          <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'^7.10.4'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">//该插件用于将ES6+中的扩展运算符（spread operator）转换为ES5代码，以便它们可以在不支持该语法的旧版浏览器中运行。</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/plugin-transform-spread'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//该插件用于将ES6+中的类属性（class properties）转换为ES5代码，以便它们可以在不支持该语法的旧版浏览器中运行。</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/plugin-proposal-class-properties'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//该插件用于将ES6+中的类（class）转换为ES5代码，以便它们可以在不支持该语法的旧版浏览器中运行。</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/plugin-transform-classes'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//插件用于在开发环境中添加警告信息，以帮助开发人员更好地调试代码。它会在控制台中输出类似于“Warning: Some warning message”的消息</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-plugin-transform-dev-warning'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token comment">//包含了 Babel 转换所需的 preset 和 plugins。其中，</span>
  <span class="token comment">// @babel/preset-react 用于转换 React 代码，</span>
  <span class="token comment">// @babel/preset-env 用于转换 ES6+ 代码，</span>
  <span class="token comment">// 根据 modules 参数判断是否启用模块转换，</span>
  <span class="token comment">// targets 选项指定了 Babel 转换的目标浏览器或者 Node.js 版本，这里如果存在</span>
  <span class="token comment">//  .browserslistrc 文件则不进行指定。返回的对象中还包含了之前定义的 plugins 数组。</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-react'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          modules<span class="token punctuation">,</span>
          <span class="token literal-property property">targets</span><span class="token operator">:</span> <span class="token function">isThereHaveBrowserslistConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token keyword">undefined</span>
            <span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">browsers</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                  <span class="token string">'last 2 versions'</span><span class="token punctuation">,</span>
                  <span class="token string">'Firefox ESR'</span><span class="token punctuation">,</span>
                  <span class="token string">'&gt; 1%'</span><span class="token punctuation">,</span>
                  <span class="token string">'ie &gt;= 11'</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    plugins<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>2、在项目中，还定义实现了一个 <code>babel</code>插件 <code>replaceLib</code> ,该插件主要的作用就是替换代码中的一些内容，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> dirname <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getProjectPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils/projectHelper'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">replacePath</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/lib\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//编译es规则时，如果代码的import语句里面有引入某个包的lib文件夹，那么修改lib为es</span>
    <span class="token keyword">const</span> esModule <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'/lib/'</span><span class="token punctuation">,</span> <span class="token string">'/es/'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> esPath <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">getProjectPath</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> esModule<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>esPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value <span class="token operator">=</span> esModule
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//替换icon的引用路径</span>
  <span class="token comment">// @ant-design/icons/xxx =&gt; @ant-design/icons/es/icons/xxx</span>
  <span class="token keyword">const</span> antdIconMatcher <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">@ant-design\/icons\/([^/]*)$</span><span class="token regex-delimiter">/</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source <span class="token operator">&amp;&amp;</span> antdIconMatcher<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> esModule <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
      antdIconMatcher<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> iconName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">@ant-design/icons/es/icons/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>iconName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
    <span class="token keyword">const</span> esPath <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">getProjectPath</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> esModule<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>esPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value <span class="token operator">=</span> esModule
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">replaceLib</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">visitor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">//匹配导入ast节点</span>
      <span class="token literal-property property">ImportDeclaration</span><span class="token operator">:</span> replacePath<span class="token punctuation">,</span>
      <span class="token comment">//匹配导出ast节点</span>
      <span class="token literal-property property">ExportNamedDeclaration</span><span class="token operator">:</span> replacePath<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> replaceLib
</code></pre></div><p><code>compile</code>命令最后还有一步 <code>compile-finalize</code>任务，该任务只是对项目中的一些特定文件进行了一个复制操作，将<code>components</code>下面的一些文件移动到了<code>es和lib</code>目录下面，此处就不多做解释了，</p> <p>接下来我们来看看 <code>npm run build</code>命令的后半部分，<code>npm run dist</code>的实现：</p> <p><strong>疑问</strong>.
此处抛出一个疑问，其实经历过了<code>compile</code>阶段，组件已经能够使用并且支持 es6 和 commonjs 规范的引入，为什么还需要一个 dist 打包的 min 文件呢？</p> <p><strong>解答</strong>.</p> <ul><li>Ant Design 生成的 es 和 lib 目录分别包含了 ES Module 和 CommonJS Module 格式的代码，用于不同的模块加载器和打包工具。es 目录中的代码可以被 Webpack 等打包工具直接引入，而 lib 目录中的代码则适用于 Node.js 和一些其他的打包工具。而 dist 目录则是专门为浏览器端打包准备的，其中的代码已经经过了压缩和优化，可以直接在浏览器中使用。使用 Ant Design 的用户可以直接引入 dist 目录中的文件，而无需关心具体的模块加载方式和打包工具。</li></ul> <p><code>npm run dist</code>:
<code>antd</code>在生成<code>dist</code>包的过程主要使用了<code>webpack</code>的打包，执行<code>npm run dist</code>的时候，最中会去执行 一个 名为 <code>dist</code>的 gulp 任务，在 dist 任务中，再去调用 dist 函数</p> <div class="language-js extra-class"><pre class="language-js"><code>gulp<span class="token punctuation">.</span><span class="token function">task</span><span class="token punctuation">(</span>
  <span class="token string">'dist'</span><span class="token punctuation">,</span>
  gulp<span class="token punctuation">.</span><span class="token function">series</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">dist</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p><code>dist方法</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">dist</span><span class="token punctuation">(</span><span class="token parameter">done</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//首先删除dist文件目录</span>
  rimraf<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token function">getProjectPath</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">RUN_ENV</span> <span class="token operator">=</span> <span class="token string">'PRODUCTION'</span> <span class="token comment">//设置环境变量为生产</span>
  <span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">getProjectPath</span><span class="token punctuation">(</span><span class="token string">'webpack.config.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//加载webpack配置文件</span>
  <span class="token comment">//执行打包</span>
  <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack <span class="token operator">||</span> err<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>details<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">dist</span><span class="token operator">:</span> <span class="token punctuation">{</span> finalize <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bail <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//如果构建的过程中有错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">;</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>errors <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token comment">// https://github.com/ant-design/ant-design/pull/31662</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果构建的过程中有警告</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">hasWarnings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>warnings<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//打印构建之后的产物信息</span>
    <span class="token keyword">const</span> buildInfo <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">colors</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">chunkModules</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">hash</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buildInfo<span class="token punctuation">)</span>

    <span class="token comment">// Additional process of dist finalize，一些文件的移动</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>finalize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[Dist] Finalization...'</span><span class="token punctuation">)</span>
      <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//结束</span>
    <span class="token function">done</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们来看看 <code>antd</code> 的 <code>webpack</code>详细配置，这里我粘贴了大致的配置项</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//加载一些babel配置</span>
<span class="token keyword">const</span> babelConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./getBabelCommonConfig'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>modules <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token comment">// babel import for components 按需加载</span>
babelConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-plugin-import'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">libraryName</span><span class="token operator">:</span> pkg<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    <span class="token literal-property property">libraryDirectory</span><span class="token operator">:</span> <span class="token string">'components'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// Other package  按需引入css</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>pkg<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'antd'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  babelConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-plugin-import'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">'css'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">libraryDirectory</span><span class="token operator">:</span> <span class="token string">'es'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">libraryName</span><span class="token operator">:</span> <span class="token string">'antd'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'other-package-babel-plugin-import'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//加入了自定义的babel插件，用来替换代码中的一些语法</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>modules <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  babelConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./replaceLib'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'D:\\gitee\\antd5-react-doc\\dist\\'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token string">'antd'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span> <span class="token comment">//umd的打包模式</span>
    <span class="token literal-property property">globalObject</span><span class="token operator">:</span> <span class="token string">'this'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'node_modules'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'.web.tsx'</span><span class="token punctuation">,</span>
      <span class="token string">'.web.ts'</span><span class="token punctuation">,</span>
      <span class="token string">'.web.jsx'</span><span class="token punctuation">,</span>
      <span class="token string">'.web.js'</span><span class="token punctuation">,</span>
      <span class="token string">'.ts'</span><span class="token punctuation">,</span>
      <span class="token string">'.tsx'</span><span class="token punctuation">,</span>
      <span class="token string">'.js'</span><span class="token punctuation">,</span>
      <span class="token string">'.jsx'</span><span class="token punctuation">,</span>
      <span class="token string">'.json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">antd</span><span class="token operator">:</span> <span class="token string">'当前项目目录'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">node</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">child_process</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cluster</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dgram</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dns</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">fs</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">net</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">readline</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">repl</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tls</span><span class="token operator">:</span> <span class="token string">'empty'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">noParse</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//不需要解析</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> babelConfig<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.tsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'babel-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> babelConfig<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'ts-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">transpileOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'css-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'postcss-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">postcssOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'autoprefixer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// Images</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.svg(\?v=\d+\.\d+\.\d+)?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'url-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
          <span class="token literal-property property">minetype</span><span class="token operator">:</span> <span class="token string">'image/svg+xml'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpg|jpeg|gif)(\?v=\d+\.\d+\.\d+)?$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'url-loader'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">limit</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CaseSensitivePathsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//该插件会自动检查模块路径的大小写是否正确,主要用于检测路径的大小写，在 Windows 操作系统中，文件名的大小写是不区分的</span>
    <span class="token comment">//插入商标</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>BannerPlugin</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pkg<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> v</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pkg<span class="token punctuation">.</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">

Copyright 2015-present, Alipay, Inc.
All rights reserved.
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 在终端中显示 Webpack 构建进度条和构建状态</span>
    <span class="token keyword">new</span> <span class="token class-name">WebpackBar</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'🚚  Ant Design Tools'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#2f54eb'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//清理 Webpack 构建过程中生成的 stats 文件</span>
    <span class="token keyword">new</span> <span class="token class-name">CleanUpStatsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//滤 Webpack 构建过程中产生的警告信息</span>
    <span class="token keyword">new</span> <span class="token class-name">FilterWarningsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// suppress conflicting order warnings from mini-css-extract-plugin.</span>
      <span class="token comment">// ref: https://github.com/ant-design/ant-design/issues/14895</span>
      <span class="token comment">// see https://github.com/webpack-contrib/mini-css-extract-plugin/issues/250</span>
      <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">mini-css-extract-plugin[^]*Conflicting order between:</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">//performance 属性用于控制构建性能的相关设置</span>
  <span class="token comment">/**
   * 当 hints 属性的值为 false 时，Webpack 将不会输出任何性能提示信息。这意味着，
   * 无论构建过程中的文件大小、构建时间等是否超过了预设的限制，Webpack 都将不会发出任何警告或错误信息，而是简单地继续进行构建。
   */</span>
  <span class="token literal-property property">performance</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hints</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//需要在代码中引用一些外部依赖库，例如全局变量或 CDN 资源，减小打包体积</span>
  <span class="token literal-property property">externals</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token string">'React'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">commonjs2</span><span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">commonjs</span><span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">amd</span><span class="token operator">:</span> <span class="token string">'react'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">'react-dom'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token string">'ReactDOM'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">commonjs2</span><span class="token operator">:</span> <span class="token string">'react-dom'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">commonjs</span><span class="token operator">:</span> <span class="token string">'react-dom'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">amd</span><span class="token operator">:</span> <span class="token string">'react-dom'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dayjs</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">root</span><span class="token operator">:</span> <span class="token string">'dayjs'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">commonjs2</span><span class="token operator">:</span> <span class="token string">'dayjs'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">commonjs</span><span class="token operator">:</span> <span class="token string">'dayjs'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">amd</span><span class="token operator">:</span> <span class="token string">'dayjs'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">parallel</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">uglifyOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">warnings</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//入口</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'antd.min'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./index'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">//语言的入口</span>
    <span class="token string-property property">'antd-with-locales.min'</span><span class="token operator">:</span> <span class="token string">'./index-with-locales.js'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过这些我们就可以打包生成 <code>antd.min.js</code></p> <h2 id="组件库单元测试"><a href="#组件库单元测试" class="header-anchor">#</a> 组件库单元测试</h2> <p><code>antd5</code>中的单元测试主要用的是 <code>jest</code>工具，<code>Jest</code> 是 <code>Facebook</code> 出品的一个测试框架，相对其他测试框架，其一大特点就是就是内置了常用的测试工具，比如自带断言、<code>Mock</code> 功能、测试覆盖率工具，实现了开箱即用，在<code>package.json</code>的 <code>script</code>字段中，我们可以看到这一个命令：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest --config .jest.js --no-cache&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>jest</code> 的测试脚本名形如 <code>*.test.js</code>，不论 <code>Jest</code> 是全局运行还是通过 <code>npm run test</code> 运行，它都会执行当前目录下所有的<code>*.test.js 或 *.spec.js</code> 文件、完成测试。</p> <p>下面我们去看看 <code>.jest.js</code>这个配置文件的内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定需要编译的模块列表</span>
<span class="token keyword">const</span> compileModules <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'dnd-core'</span><span class="token punctuation">,</span>
  <span class="token string">'react-sticky-box'</span><span class="token punctuation">,</span>
  <span class="token string">'tween-one'</span><span class="token punctuation">,</span>
  <span class="token string">'@babel'</span><span class="token punctuation">,</span>
  <span class="token string">'@ant-design'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">const</span> ignoreList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">// cnpm use `_` as prefix</span>
<span class="token punctuation">;</span><span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">prefix</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  compileModules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ignoreList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>module<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 忽略转换模块的正则表达式列表</span>
<span class="token comment">// 匹配 node_modules 目录下的模块，但是排除 ignoreList 中指定的模块</span>
<span class="token keyword">const</span> transformIgnorePatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token comment">// Ignore modules without es dir.</span>
  <span class="token comment">// Update: @babel/runtime should also be transformed</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/node_modules/(?!</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ignoreList<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)[^/]+?/(?!(es)/)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">function</span> <span class="token function">getTestRegex</span><span class="token punctuation">(</span><span class="token parameter">libDir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'dist'</span><span class="token punctuation">,</span> <span class="token string">'lib'</span><span class="token punctuation">,</span> <span class="token string">'es'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>libDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'demo\\.test\\.(j|t)sx?$'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token string">'.*\\.test\\.(j|t)sx?$'</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">verbose</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 指示是否应在运行期间报告每个测试</span>
  <span class="token literal-property property">testEnvironment</span><span class="token operator">:</span> <span class="token string">'jsdom'</span><span class="token punctuation">,</span> <span class="token comment">// 使用 JSDOM 运行测试</span>
  <span class="token literal-property property">setupFiles</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./tests/setup.js'</span><span class="token punctuation">,</span> <span class="token string">'jest-canvas-mock'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 指定在执行测试之前需要运行的文件</span>
  <span class="token literal-property property">setupFilesAfterEnv</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./tests/setupAfterEnv.ts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 指定在执行测试之后需要运行的文件</span>
  <span class="token literal-property property">moduleFileExtensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ts'</span><span class="token punctuation">,</span> <span class="token string">'tsx'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'jsx'</span><span class="token punctuation">,</span> <span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token string">'md'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 允许 Jest 解析的文件扩展名列表</span>
  <span class="token literal-property property">modulePathIgnorePatterns</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/_site/'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 指定 Jest 忽略的模块路径，这里包括 /_site/</span>
  <span class="token comment">// 指定模块名称的映射关系，用于将指定的模块名称转换为另一个模块名称。</span>
  <span class="token literal-property property">moduleNameMapper</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'/\\.(css|less)$/'</span><span class="token operator">:</span> <span class="token string">'identity-obj-proxy'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'^antd$'</span><span class="token operator">:</span> <span class="token string">'&lt;rootDir&gt;/components/index'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'^antd/es/(.*)$'</span><span class="token operator">:</span> <span class="token string">'&lt;rootDir&gt;/components/$1'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 忽略特定测试文件的正则表达式列表</span>
  <span class="token literal-property property">testPathIgnorePatterns</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'/node_modules/'</span><span class="token punctuation">,</span>
    <span class="token string">'dekko'</span><span class="token punctuation">,</span>
    <span class="token string">'node'</span><span class="token punctuation">,</span>
    <span class="token string">'image.test.js'</span><span class="token punctuation">,</span>
    <span class="token string">'image.test.ts'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 指定转换器（preprocessor）的映射关系，用于将指定类型的文件转换为 JavaScript 代码</span>
  <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'\\.tsx?$'</span><span class="token operator">:</span> <span class="token string">'./node_modules/@ant-design/tools/lib/jest/codePreprocessor'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\\.(m?)js$'</span><span class="token operator">:</span> <span class="token string">'./node_modules/@ant-design/tools/lib/jest/codePreprocessor'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\\.md$'</span><span class="token operator">:</span> <span class="token string">'./node_modules/@ant-design/tools/lib/jest/demoPreprocessor'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'\\.(jpg|png|gif|svg)$'</span><span class="token operator">:</span>
      <span class="token string">'./node_modules/@ant-design/tools/lib/jest/imagePreprocessor'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 指定 Jest 应该运行哪些测试</span>
  <span class="token literal-property property">testRegex</span><span class="token operator">:</span> <span class="token function">getTestRegex</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">LIB_DIR</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 指定哪些文件需要收集代码覆盖率信息。</span>
  <span class="token literal-property property">collectCoverageFrom</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'components/**/*.{ts,tsx}'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/*/style/index.tsx'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/style/index.tsx'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/*/locale/index.tsx'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/*/__tests__/type.test.tsx'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/**/*/interface.{ts,tsx}'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/*/__tests__/image.test.{ts,tsx}'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/__tests__/node.test.tsx'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/*/demo/*.tsx'</span><span class="token punctuation">,</span>
    <span class="token string">'!components/*/design/**'</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  transformIgnorePatterns<span class="token punctuation">,</span> <span class="token comment">// 忽略转换模块的正则表达式列表,转换器要忽略的路径</span>
  <span class="token comment">// 试环境中可使用的全局变量</span>
  <span class="token literal-property property">globals</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'ts-jest'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">tsConfig</span><span class="token operator">:</span> <span class="token string">'./tsconfig.test.json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">testEnvironmentOptions</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">'http://localhost'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// bail: true,</span>
  <span class="token literal-property property">maxWorkers</span><span class="token operator">:</span> <span class="token string">'50%'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来，我们去看看 <code>antd</code> 中组件的测试用例怎么写的，以 <code>Button</code> 组件为例，下面我只是截取了一部分的<code>Button</code>测试用例</p> <p>相关函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 挂载测试</span>
<span class="token comment">// eslint-disable-next-line jest/no-export</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">mountTest</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Component</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ComponentType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mount and unmount</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// https://github.com/ant-design/ant-design/pull/18441</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">component could be updated and unmounted without errors</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此处的render方法由 @testing-library/react 工具提供</span>
      <span class="token comment">// 返回一个渲染和卸载方法</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> unmount<span class="token punctuation">,</span> rerender <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Component <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">rerender</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Component <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 表示前面的语句不应该抛出异常，如果有异常则测试失败。</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Right-to-Left，从右向左）方向下是否能够正确地渲染</span>
<span class="token keyword">const</span> <span class="token function-variable function">rtlTest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Component</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ComponentType<span class="token punctuation">,</span> mockDate <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'rtl render'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'component should be rendered correctly in RTL direction'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mockDate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MockDate<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">dayjs</span><span class="token punctuation">(</span><span class="token string">'2000-09-28'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> container <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>ConfigProvider direction<span class="token operator">=</span><span class="token string">&quot;rtl&quot;</span><span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span>Component <span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ConfigProvider<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 然后将渲染结果的第一个子节点与之前保存的快照进行比较</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mockDate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MockDate<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> resetWarned <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rc-util/lib/warning'</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> Button <span class="token keyword">from</span> <span class="token string">'..'</span>
<span class="token keyword">import</span> mountTest <span class="token keyword">from</span> <span class="token string">'../../../tests/shared/mountTest'</span>
<span class="token keyword">import</span> rtlTest <span class="token keyword">from</span> <span class="token string">'../../../tests/shared/rtlTest'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../../tests/utils'</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Button'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 挂载测试</span>
  <span class="token function">mountTest</span><span class="token punctuation">(</span>Button<span class="token punctuation">)</span>
  <span class="token function">mountTest</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>Button size<span class="token operator">=</span><span class="token string">&quot;large&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token comment">// Right-to-Left，从右向左）方向下是否能够正确地渲染</span>
  <span class="token function">rtlTest</span><span class="token punctuation">(</span>Button<span class="token punctuation">)</span>
  <span class="token function">rtlTest</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>Button size<span class="token operator">=</span><span class="token string">&quot;large&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
  <span class="token function">rtlTest</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>Button size<span class="token operator">=</span><span class="token string">&quot;small&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>

  <span class="token comment">// 将渲染结果的第一个子节点与之前保存的快照进行比较，如果不一致则测试失败</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders correctly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> container <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span>Follow<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'mount correctly'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 表示前面的语句不应该抛出异常，如果有异常则测试失败。</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span>Follow<span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'warns if size is wrong'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resetWarned</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 重置警告信息状态</span>
    <span class="token comment">// 创建一个模拟的 console.error 函数，以便在测试过程中捕获警告信息</span>
    <span class="token keyword">const</span> mockWarn <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">spyOn</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token string">'who am I'</span>
    <span class="token comment">// @ts-expect-error: Type '&quot;who am I&quot;' is not assignable to type 'SizeType'.ts(2322)</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Button<span class="token punctuation">.</span>Group size<span class="token operator">=</span><span class="token punctuation">{</span>size<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
    <span class="token comment">// 表示检查是否捕获到了警告信息，并且该信息是否包含特定的内容</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mockWarn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span>
      <span class="token string">'Warning: [antd: Button.Group] Invalid prop `size`.'</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 还原模拟的 console.error 函数的实现</span>
    mockWarn<span class="token punctuation">.</span><span class="token function">mockRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'renders Chinese characters correctly in HOC'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">Text</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">children</span><span class="token operator">:</span> React<span class="token punctuation">.</span>ReactNode <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> container<span class="token punctuation">,</span> rerender <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Text<span class="token operator">&gt;</span>按钮<span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ant-btn'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveClass</span><span class="token punctuation">(</span>
      <span class="token string">'ant-btn-two-chinese-chars'</span>
    <span class="token punctuation">)</span>

    <span class="token function">rerender</span><span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>Button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Text<span class="token operator">&gt;</span>大按钮<span class="token operator">&lt;</span><span class="token operator">/</span>Text<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Button<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
    <span class="token comment">// 验证是否有这个class 类</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ant-btn'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toHaveClass</span><span class="token punctuation">(</span>
      <span class="token string">'ant-btn-two-chinese-chars'</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="ts-node"><a href="#ts-node" class="header-anchor">#</a> ts-node</h2> <p><code>ts-node</code> 是一个<code>Node.js</code>的执行环境，它可以让你在<code>Node.js</code> 环境中直接运行<code>TypeScript</code> 代码。 它通过在运行时将<code>TypeScript</code> 转译为<code>JavaScript</code>来实现这一点，因此你不需要在编写<code>TypeScript</code>代码之前先将其转译为<code>JavaScript</code>。</p> <h2 id="pre-publish-的一些检查"><a href="#pre-publish-的一些检查" class="header-anchor">#</a> pre-publish 的一些检查</h2> <p>在<code>antd</code>发布新的版本之前，内部会先执行一个 <code>npm run pre-publish</code>命令，改命令会对项目中的一些配置或者代码规范做一个检查，下面我们来看看</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;pre-publish&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run test-all -- --skip-build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test-all&quot;</span><span class="token operator">:</span> <span class="token string">&quot;sh -e ./scripts/test-all.sh&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行 <code>pre-publish</code> 命令最后会去执行一个 <code>shell</code>脚本文件，根据这个脚本的命令，我们来依次研究他的命令步骤</p> <p>首先：执行<code>check-commit</code> 命令，检查各种预发布的条件（版本号，分支，git 的状态 status，远程仓库是否可以连接）</p> <p>下面是相关脚本：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* eslint-disable import/no-dynamic-require, no-console */</span>
<span class="token keyword">const</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fetch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'isomorphic-fetch'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> simpleGit <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'simple-git'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> cwd <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> git <span class="token operator">=</span> <span class="token function">simpleGit</span><span class="token punctuation">(</span>cwd<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> version <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>cwd<span class="token punctuation">,</span> <span class="token string">'package.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">exitProcess</span><span class="token punctuation">(</span><span class="token parameter">code <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment">// Keep an empty line here to make looks good~</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> versions <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://registry.npmjs.org/antd'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>version <span class="token keyword">in</span> versions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>
          <span class="token string">'😈 Current version already exists. Forget update package.json?'</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">' =&gt; Current:'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span>
      <span class="token function">exitProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'🚨 Check version failed. Skip...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkBranch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> current <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    version<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'-alpha.'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    version<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'-beta.'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    version<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'-rc.'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
    version<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'-experimental.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'😃 Alpha version. Skip branch check.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token string">'master'</span> <span class="token operator">&amp;&amp;</span> current <span class="token operator">!==</span> <span class="token string">'4.0-prepare'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token string">'🤔 You are not in the master branch!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">exitProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkCommit</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> files <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span><span class="token string">'🙄 You forgot something to commit.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    files<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> filePath<span class="token punctuation">,</span> <span class="token literal-property property">working_dir</span><span class="token operator">:</span> mark <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' -'</span><span class="token punctuation">,</span> chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span>mark<span class="token punctuation">)</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">exitProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> remote <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> git<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'origin'</span><span class="token punctuation">,</span> <span class="token string">'master'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remote<span class="token operator">?.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'ant-design/ant-design'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>
          <span class="token string">'😓 Your remote origin is not ant-design/ant-design, did you fork it?'</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token function">exitProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token string">'🚨 Check remote failed. Skip...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">checkAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> status <span class="token operator">=</span> <span class="token keyword">await</span> git<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">await</span> <span class="token function">checkVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">await</span> <span class="token function">checkBranch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>

  <span class="token keyword">await</span> <span class="token function">checkCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>

  <span class="token keyword">await</span> <span class="token function">checkRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">checkAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>然后第二步会去执行：<code>npm run lint</code></p> <p><code>npm run lint</code> 命令会将新的版本号写入到 <code>version.ts</code> 中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs-extra'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> version <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span>

fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> <span class="token string">'version'</span><span class="token punctuation">,</span> <span class="token string">'version.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">export default '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">';</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token string">'utf8'</span>
<span class="token punctuation">)</span>
</code></pre></div><p>然后会去执行 <code>tsc --noEmit</code> 命令</p> <p>执行<code>tsc --noEmit</code>, <code>TSC</code> 会读取配置文件获取参数值，<code>--noEmit</code>的作用是只进行检查，不进行编译输出。如果我们的代码无错，会直接退出，否则报错</p> <p>最后会去执行 <code>npm run test</code> 命令</p> <p>就是会跑一遍项目里面的单元测试，只有所有的单元测试都通过了，才能达到发布的标准</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest --config .jest.js --no-cache&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test-node&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run version &amp;&amp; jest --config .jest.node.js --no-cache&quot;</span> <span class="token comment">//执行node环境下的单元测试文件</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="按需加载"><a href="#按需加载" class="header-anchor">#</a> 按需加载</h2></div> <footer class="page-edit"><!----> <!----></footer> <div><div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/前端生态/flutter消息推送.html" class="prev">
        flutter消息推送
      </a></span> <span class="next"><a href="/前端生态/element-plus架构分析.html">
        element-plus样式+打包分析
      </a>
      →
    </span></p></div> <div class="icp-footer"><p>Copyright© 2022-2023 _妄想何方</p> <a href="https://beian.miit.gov.cn/" target="_blank">蜀ICP备2022010321号-1</a></div></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a5e2a326.js" defer></script><script src="/assets/js/2.a6634917.js" defer></script><script src="/assets/js/7.5b3397e2.js" defer></script><script src="/assets/js/11.8af1e3cd.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>svelte | 学习笔记</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="前端技术相关的文章，包含不限于vue，react，webpack，nodejs，算法等等">
    
    <link rel="preload" href="/Study-Notes/assets/css/0.styles.860b9138.css" as="style"><link rel="preload" href="/Study-Notes/assets/js/app.3ac2ea1f.js" as="script"><link rel="preload" href="/Study-Notes/assets/js/2.950c954c.js" as="script"><link rel="preload" href="/Study-Notes/assets/js/3.bb3ecbf5.js" as="script"><link rel="preload" href="/Study-Notes/assets/js/13.1dd4895a.js" as="script"><link rel="prefetch" href="/Study-Notes/assets/js/10.6f3f3fcb.js"><link rel="prefetch" href="/Study-Notes/assets/js/11.426d95d3.js"><link rel="prefetch" href="/Study-Notes/assets/js/12.03ea809b.js"><link rel="prefetch" href="/Study-Notes/assets/js/14.8ae434e3.js"><link rel="prefetch" href="/Study-Notes/assets/js/15.84c0e4ee.js"><link rel="prefetch" href="/Study-Notes/assets/js/16.97badf3c.js"><link rel="prefetch" href="/Study-Notes/assets/js/17.c4bbb1b9.js"><link rel="prefetch" href="/Study-Notes/assets/js/18.65ab323a.js"><link rel="prefetch" href="/Study-Notes/assets/js/19.2e1f1dd9.js"><link rel="prefetch" href="/Study-Notes/assets/js/20.0b87bdb1.js"><link rel="prefetch" href="/Study-Notes/assets/js/21.93f04747.js"><link rel="prefetch" href="/Study-Notes/assets/js/22.39edd522.js"><link rel="prefetch" href="/Study-Notes/assets/js/23.072a73e9.js"><link rel="prefetch" href="/Study-Notes/assets/js/24.2079b0ae.js"><link rel="prefetch" href="/Study-Notes/assets/js/25.f982991f.js"><link rel="prefetch" href="/Study-Notes/assets/js/26.7668d4c6.js"><link rel="prefetch" href="/Study-Notes/assets/js/27.c370df01.js"><link rel="prefetch" href="/Study-Notes/assets/js/28.64cb1036.js"><link rel="prefetch" href="/Study-Notes/assets/js/29.c2a0c961.js"><link rel="prefetch" href="/Study-Notes/assets/js/30.51a024e5.js"><link rel="prefetch" href="/Study-Notes/assets/js/31.bc2d8c44.js"><link rel="prefetch" href="/Study-Notes/assets/js/32.41d47c71.js"><link rel="prefetch" href="/Study-Notes/assets/js/33.d689c8d6.js"><link rel="prefetch" href="/Study-Notes/assets/js/34.450d1e4b.js"><link rel="prefetch" href="/Study-Notes/assets/js/35.6616fe43.js"><link rel="prefetch" href="/Study-Notes/assets/js/36.b208e363.js"><link rel="prefetch" href="/Study-Notes/assets/js/37.7c55f4d2.js"><link rel="prefetch" href="/Study-Notes/assets/js/38.7d2c3749.js"><link rel="prefetch" href="/Study-Notes/assets/js/39.19492976.js"><link rel="prefetch" href="/Study-Notes/assets/js/4.4b4578d7.js"><link rel="prefetch" href="/Study-Notes/assets/js/40.f394c5bc.js"><link rel="prefetch" href="/Study-Notes/assets/js/41.c7a58763.js"><link rel="prefetch" href="/Study-Notes/assets/js/42.865c8e6e.js"><link rel="prefetch" href="/Study-Notes/assets/js/43.408443ae.js"><link rel="prefetch" href="/Study-Notes/assets/js/5.9d2fff8f.js"><link rel="prefetch" href="/Study-Notes/assets/js/6.90674ba6.js"><link rel="prefetch" href="/Study-Notes/assets/js/7.e129d5bc.js"><link rel="prefetch" href="/Study-Notes/assets/js/8.33255775.js"><link rel="prefetch" href="/Study-Notes/assets/js/9.9541ef9d.js">
    <link rel="stylesheet" href="/Study-Notes/assets/css/0.styles.860b9138.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Study-Notes/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Study-Notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/Study-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Study-Notes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="https://github.com/Z-p-github/Study-Notes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/Study-Notes/" aria-current="page" class="sidebar-link">主页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/JavaScript/小顶堆.html" class="sidebar-link">小顶堆</a></li><li><a href="/Study-Notes/JavaScript/位运算.html" class="sidebar-link">位运算</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><p class="sidebar-heading open"><span>React Fiber</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/React/React-Fiber/React理念.html" class="sidebar-link">React理念</a></li><li><a href="/Study-Notes/React/React-Fiber/ReactFiber架构.html" class="sidebar-link">Fiber架构</a></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>React Fiber Render</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/beginWork.html" class="sidebar-link">beginWork阶段</a></li><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/completeWork.html" class="sidebar-link">completeWork阶段</a></li><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/commit.html" class="sidebar-link">commit阶段</a></li><li><a href="/Study-Notes/React/React-Fiber/Fiber-dom-diff/domdiff.html" class="sidebar-link">completeWork-diff阶段</a></li></ul></section></li><li><section class="sidebar-group is-sub-group depth-2"><p class="sidebar-heading"><span>Concurrent Mode</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/React/Concurrent-Mode/React中的事件优先级调度.html" class="sidebar-link">React事件优先级调度</a></li><li><a href="/Study-Notes/React/Concurrent-Mode/scheduler.html" class="sidebar-link">scheduler具体实现</a></li><li><a href="/Study-Notes/React/Concurrent-Mode/lane.html" class="sidebar-link">lane模型</a></li></ul></section></li><li><a href="/Study-Notes/React/React17.html" class="sidebar-link">React17</a></li><li><a href="/Study-Notes/React/React18.html" class="sidebar-link">React18</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/Vue/Vue3+Typescript实现Form组件.html" class="sidebar-link">Vue3+Typescript实现Form组件</a></li><li><a href="/Study-Notes/Vue/搭建vue3和ts组件库开发环境.html" class="sidebar-link">搭建vue3和ts组件库开发环境</a></li><li><a href="/Study-Notes/Vue/Vite2配置项目开发环境.html" class="sidebar-link">Vite2配置项目开发环境</a></li><li><a href="/Study-Notes/Vue/基于Element-plus实现虚拟下拉组件.html" class="sidebar-link">基于Element-plus实现虚拟下拉组件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>前端生态</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/前端生态/eslint.html" class="sidebar-link">eslint</a></li><li><a href="/Study-Notes/前端生态/flutter实践.html" class="sidebar-link">flutter实践</a></li><li><a href="/Study-Notes/前端生态/flutter消息推送.html" class="sidebar-link">flutter消息推送</a></li><li><a href="/Study-Notes/前端生态/antd5架构分析.html" class="sidebar-link">antd5研究</a></li><li><a href="/Study-Notes/前端生态/element-plus架构分析.html" class="sidebar-link">element-plus样式+打包分析</a></li><li><a href="/Study-Notes/前端生态/ts类型打包.html" class="sidebar-link">ts类型打包</a></li><li><a href="/Study-Notes/前端生态/vscode扩展工具.html" class="sidebar-link">vscode扩展工具实现</a></li><li><a href="/Study-Notes/前端生态/svelte.html" class="active sidebar-link">svelte框架</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Study-Notes/前端生态/svelte.html#svelte" class="sidebar-link">svelte</a></li></ul></li><li><a href="/Study-Notes/前端生态/i18n.html" class="sidebar-link">国际化解决方案</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>go</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Study-Notes/go/mac如何安装grpc.html" class="sidebar-link">mac安装grpc</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="svelte"><a href="#svelte" class="header-anchor">#</a> svelte</h2> <p>最近由于公司内部需求，需要将一个组件提成公共组件，可以跨项目和跨技术栈使用，我们公司同时存在<code>vue</code>和<code>react</code>技术栈，考虑到以下几个问题：</p> <ul><li>1、<code>不同技术栈的存在</code>，由于前端项目中同时存在 React 和 Vue 框架，以及前端框架的不同版本，需要确保 Copilot 能够跨这些不同的技术栈进行使用</li> <li>2、<code>维护性和可扩展性</code>，为了降低维护成本并提高项目的可扩展性，期望将 Copilot 作为一个公共组件库来统一管理和维护</li> <li>3、<code>多平台应用</code>，提取的公共组件需要跨平台使用，需要考虑平台接入的兼容性和难易程度</li> <li>4、<code>学习成本</code>，需要团队成员能够快速上手开发或接入，减少团队成员的学习成本</li></ul> <p>我们决定使用 <code>svelte</code>框架来实现</p> <h3 id="如何封装一个能够支持跨前端框架-的组件"><a href="#如何封装一个能够支持跨前端框架-的组件" class="header-anchor">#</a> 如何封装一个能够支持跨前端框架 的组件</h3> <p>目前市场上有其他几种方案可以支持</p> <p><code>Vanilla JS</code></p> <p>优点：</p> <ul><li>1、所有框架中都支持</li></ul> <p>缺点：</p> <ul><li>1、命令式编程方式</li> <li>2、DOM 操作繁琐</li> <li>3、开发效率低</li> <li>4、代码冗余</li></ul> <p><code>Web Components</code></p> <p>优点：</p> <ul><li>1、原生浏览器支持，具备天然的跨框架特性</li></ul> <p>缺点：</p> <ul><li>1、兼容性问题，浏览器支持不完全</li> <li>2、引入的新概念比较多，学习成本较大</li> <li>3、仍存在很多试验性 API，仍存在变动的可能</li></ul> <h3 id="svelte-优点"><a href="#svelte-优点" class="header-anchor">#</a> svelte 优点</h3> <p>选择的<code>svelte</code>的原因如下：</p> <p>优点：</p> <ul><li><p>1、语法简单，语法和 vue 3 很像</p></li> <li><p>2、高性能前端框架</p></li> <li><p>3、打包的产物很小，它可以把组件打包成 <code>JS Class</code> 的形式，打包产物是无框架的，<code>Svelte</code> 的核心思想在于『通过静态编译减少框架运行时的代码量』。举例来说，当前的框架无论是 React Angular 还是 Vue，不管你怎么编译，使用的时候必然需要『引入』框架本身，也就是所谓的<code>运行时 (runtime)</code>。但是用 <code>Svelte</code> 就不一样，一个 <code>Svelte</code> 组件编译了以后，所有需要的运行时代码都包含在里面了，除了引入这个组件本身，你不需要再额外引入一个所谓的框架运行时！</p></li> <li><p>4、无虚拟 DOM、无运行时</p></li> <li><p>5、基于 <code>Svelte</code> 开发的组件，可以直接给使用 <code>Vue、React、Angular、Svelte</code> 技术栈的团队用， 而不需要额外引入 <code>Svelte</code> 去承载解析翻译的工作。</p></li> <li><p>6、上手简单，<code>Svelte</code> 把框架代码编写风格设计跟 <code>Vue</code> 很像。编写一个 <code>Svelte</code> 组件的体验，跟开发<code>原生 Web</code> 基本相同</p></li></ul> <img src="/Study-Notes/assets/img/priority.574943cb.png" alt="center" height="150"> <p><code>Svelte</code>放弃了流行的<code>虚拟DOM</code>方案，虽然<code>虚拟DOM</code>足够的快，但是<code>虚拟DOM</code>最致命的问题是不管状态是否发生变化，都会被重新计算并且更新，<code>Svelte</code> 将需要在运行时做的事情，提前到编译阶段完成，所以它几乎没有运行时。提前分析依赖，运行阶段无需处理依赖收集、<code>虚拟 DOM</code>比较等额外计算，减少了运行时的负担。<code>Svelte</code> 的编译风格是将模板编译为<code>命令式 (imperative)</code>的<code>原生 DOM</code> 操作。比如这段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
	<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'world123'</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Hello <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
</code></pre></div><p>会被编译为:</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'world123'</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">create_fragment</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">let</span> h1<span class="token punctuation">;</span>

    	<span class="token keyword">return</span> <span class="token punctuation">{</span>
    		<span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			h1 <span class="token operator">=</span> <span class="token function">element</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    			h1<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span><span class="token punctuation">,</span>
    		<span class="token function">m</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			<span class="token function">insert</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span><span class="token punctuation">,</span>
    		<span class="token literal-property property">p</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>
    		<span class="token literal-property property">i</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>
    		<span class="token literal-property property">o</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>
    		<span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">detaching</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			<span class="token keyword">if</span> <span class="token punctuation">(</span>detaching<span class="token punctuation">)</span> <span class="token function">detach</span><span class="token punctuation">(</span>h1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
    	<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre></div><p>可以看到，跟基于 Virtual DOM 的框架相比，这样的输出不需要 Virtual DOM 的 diff/patch 操作，自然可以省去大量代码。</p> <p>对于特定功能，<code>Svelte</code> 依然有对应的运行时代码，比如组件逻辑，<code>if/else</code> 切换逻辑，循环逻辑等等... 但它在编译时，如果一个功能没用到，对应的代码就根本不会被编译到结果里去。这就好像用 <code>Babel</code> 的时候没有用到的功能的 <code>helper</code> 是不会被引入的，又好像用 <code>lodash</code> 或者 <code>RxJS</code> 的时候只选择性地引入对应的函数。</p> <h3 id="svelte缺点"><a href="#svelte缺点" class="header-anchor">#</a> svelte缺点</h3> <ul><li>1、生态不够成熟，<code>Svelte</code> 生态数量仅有 <code>Vue 生态的 7.7%，React 的 1.5%</code></li> <li>2、多个组件中会有很多重复的代码，虽然在简单的 <code>demo</code> 里面代码量确实非常小，但同样的组件模板，这样的 命令式 操作生成的代码量会比 <code>vdom 渲染函数</code>要大，多个组件中会有很多重复的代码<code>（虽然 gzip 时候可以缓解，但 parse 是免不了的）</code>。项目里的组件越多，代码量的差异就会逐渐缩小。同时，并不是真正的如宣传的那样 没有 runtime““，而是根据你的代码按需 <code>import</code> 而已。使用的功能越多，<code>Svelte</code> 要包含的运行时代码也越多，最终在实际生产项目中能有多少尺寸优势，其实很难说</li> <li>3、<code>Svelte</code> 在大型应用中的性能还有待观察，尤其是在大量动态内容和嵌套组件的情况下</li> <li>4、<code>Svelte</code>的编译策略决定了它跟 <code>Virtual DOM</code> 绝缘（渲染函数由于其动态性，无法像模板那样可以被可靠地静态分析），也就享受不到<code>Virtual DOM</code>带来的诸多好处，比如基于 <code>render function</code> 的组件的强大抽象能力，基于 <code>vdom</code> 做测试，服务端/原生渲染亲和性等等。</li></ul> <img src="/Study-Notes/assets/img/use.cc5a05ef.png" alt="center" height="150"> <h3 id="svelte核心原理"><a href="#svelte核心原理" class="header-anchor">#</a> svelte核心原理</h3> <p><code>Svelte</code> 没有使用 <code>API</code> 来创建响应式，那么它是怎么追踪变量的变化呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
	<span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">'world123'</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        name <span class="token operator">=</span> <span class="token string">'你好'</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Hello <span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>button on<span class="token operator">:</span>click<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">&gt;</span>点击改变<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre></div><p>会被编译为:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">create_fragment</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">let</span> h1<span class="token punctuation">;</span>
    	<span class="token keyword">let</span> t0<span class="token punctuation">;</span>
    	<span class="token keyword">let</span> t1<span class="token punctuation">;</span>
    	<span class="token keyword">let</span> t2<span class="token punctuation">;</span>
    	<span class="token keyword">let</span> t3<span class="token punctuation">;</span>
    	<span class="token keyword">let</span> button<span class="token punctuation">;</span>
    	<span class="token keyword">let</span> mounted<span class="token punctuation">;</span>
    	<span class="token keyword">let</span> dispose<span class="token punctuation">;</span>

    	<span class="token keyword">return</span> <span class="token punctuation">{</span>
    		<span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			h1 <span class="token operator">=</span> <span class="token function">element</span><span class="token punctuation">(</span><span class="token string">&quot;h1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    			t0 <span class="token operator">=</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//变量的值会从ctx中去获取</span>
    			t1 <span class="token operator">=</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token comment">/*name*/</span> ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//会将静态节点和变量之间分开</span>
    			t2 <span class="token operator">=</span> <span class="token function">text</span><span class="token punctuation">(</span><span class="token string">&quot;!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    			t3 <span class="token operator">=</span> <span class="token function">space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    			button <span class="token operator">=</span> <span class="token function">element</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    			button<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">&quot;点击改变&quot;</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span><span class="token punctuation">,</span>
    		<span class="token function">m</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> anchor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			<span class="token function">insert</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> h1<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			<span class="token function">append</span><span class="token punctuation">(</span>h1<span class="token punctuation">,</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			<span class="token function">append</span><span class="token punctuation">(</span>h1<span class="token punctuation">,</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			<span class="token function">append</span><span class="token punctuation">(</span>h1<span class="token punctuation">,</span> t2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			<span class="token function">insert</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> t3<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			<span class="token function">insert</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> button<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//给button绑定点击事件</span>
    				dispose <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>button<span class="token punctuation">,</span> <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token comment">/*handleClick*/</span> ctx<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    				mounted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    			<span class="token punctuation">}</span>
    		<span class="token punctuation">}</span><span class="token punctuation">,</span>
    		<span class="token function">p</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> <span class="token punctuation">[</span>dirty<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//通过 dirty 按位与 1 的结果判断是否要更新</span>
    			<span class="token keyword">if</span> <span class="token punctuation">(</span>dirty <span class="token operator">&amp;</span> <span class="token comment">/*name*/</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">set_data</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token comment">/*name*/</span> ctx<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span><span class="token punctuation">,</span>
    		<span class="token literal-property property">i</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>
    		<span class="token literal-property property">o</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>
    		<span class="token function">d</span><span class="token punctuation">(</span><span class="token parameter">detaching</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			<span class="token keyword">if</span> <span class="token punctuation">(</span>detaching<span class="token punctuation">)</span> <span class="token function">detach</span><span class="token punctuation">(</span>h1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			<span class="token keyword">if</span> <span class="token punctuation">(</span>detaching<span class="token punctuation">)</span> <span class="token function">detach</span><span class="token punctuation">(</span>t3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			<span class="token keyword">if</span> <span class="token punctuation">(</span>detaching<span class="token punctuation">)</span> <span class="token function">detach</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
    			mounted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    			<span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
    	<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>Svelte</code>在编译时，会检测所有变量的赋值行为，并将变化后的值和赋值的行为，作为创建片段的参数。</p> <p>当变量更新时：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">function</span> <span class="token function">make_dirty</span><span class="token punctuation">(</span><span class="token parameter">component<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果组件的 dirty[0] 为 -1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>component<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//需要往脏组件数组中添加，然后更新</span>
            dirty_components<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新</span>
            <span class="token function">schedule_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//更新完了，清空脏组件数组</span>
            component<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        component<span class="token punctuation">.</span>$$<span class="token punctuation">.</span>dirty<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">schedule_update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>update_scheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            update_scheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment">//调用flush方法</span>
            resolved_promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//更新</span>
    <span class="token keyword">function</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> saved_component <span class="token operator">=</span> current_component<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// first, call beforeUpdate functions</span>
            <span class="token comment">// and update components</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>flushidx <span class="token operator">&lt;</span> dirty_components<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> component <span class="token operator">=</span> dirty_components<span class="token punctuation">[</span>flushidx<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    flushidx<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token function">set_current_component</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">update</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>$$<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token operator">...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre></div><p><code>component.$$.dirty</code>  是什么?</p> <p>在一个文件中，我们设置一些变量修改，在打印一下<code>component.$$.dirty</code></p> <img src="/Study-Notes/assets/img/change.1298ba88.png" alt="center" height="150"> <p>转化成二进制就是:</p> <img src="/Study-Notes/assets/img/transform.14e9c6e7.png" alt="center"> <p>上面数组中的每一项中的每一个比特位，如果是<strong>1</strong>，则代表着该数据是否是脏数据。如果是脏数据，则意味着更新。</p> <ul><li><p>第一行 [&quot;0000000000000000000000000000001&quot;, &quot;0000000000000000000000000000000&quot;], 表示第一个数据脏了，需要更新第一个数据对应的dom节点</p></li> <li><p>第二行 [&quot;0000000000000000000000000000011&quot;, &quot;0000000000000000000000000000000&quot;], 表示第一个、第二个数据都脏了，需要更新第一个，第二个数据对应的dom节点。</p></li></ul> <h3 id="如何跨框架使用"><a href="#如何跨框架使用" class="header-anchor">#</a> 如何跨框架使用</h3> <p>1、如果你查阅 <code>Svelte</code> 官网，官方建议我们使用 <code>SvelteKit</code> 创建项目</p> <img src="/Study-Notes/assets/img/start.f7d011c2.png" alt="center"> <p><code>SvelteKit</code> 为<code>Svelte</code> 提供了开发完整 <code>APP</code> 的能力，例如<code>router、SSR</code>等特性。但事实上我们如果开发组件库，是用不上 <code>SvelteKit</code> 提供的额外功能的。
因此我们使用 <code>Vite</code> 提供的脚手架来创建 <code>Svelte</code> 项目</p> <img src="/Study-Notes/assets/img/create.0305d08b.png" alt="center"> <p>2、<code>Vite Config</code> 中引入 <code>Svelte</code> 插件</p> <img src="/Study-Notes/assets/img/vite.17539c6b.png" alt="center" height="150"> <p><code>svelte-preprocess</code> 为 <code>Svelte</code> 扩展了诸多预处理特性，例如在 <code>style 中使用 less、sass，global css</code>等</p> <p>3、组件打包配置</p> <ol><li>build 配置中设置为库打包的模式</li></ol> <img src="/Study-Notes/assets/img/build1.9fc6017f.png" alt="center" height="150"> <ol start="2"><li>使用 tsup 打包出类型定义dts</li></ol> <img src="/Study-Notes/assets/img/build2.db0602af.png" alt="center" height="150"> <ol start="3"><li>在 package.json 编写打包脚本让 vite和 tsup 同时构建</li></ol> <img src="/Study-Notes/assets/img/build3.ad18e77c.png" alt="center" height="150"> <p>4、如何编译为 <code>Web Components</code></p> <p>将 <code>Svelte</code> 编写的组件编译成 <code>Web Components</code> 组件非常简单，只需要 :</p> <ul><li>在 <code>svelte</code> 插件编译配置中开启 <code>Custom Element</code></li> <li>在组件上声明<code>svelte:options</code>，并配置组件名称即可</li></ul> <img src="/Study-Notes/assets/img/webcom1.f5563921.png" alt="center" height="150"> <img src="/Study-Notes/assets/img/webcom2.edd5b5d0.png" alt="center" height="150"> <p>5、 跨框架组件使用方式</p> <img src="/Study-Notes/assets/img/use-com1.6864d50e.png" alt="center" height="150"> <img src="/Study-Notes/assets/img/use-com2.054a14d6.png" alt="center" height="150"> <p>6、处理组件传入的 <code>Props</code></p> <ul><li><ol><li>通过 svelte/store 全局存储业务系统传入的用户信息和平台信息</li></ol></li> <li><ol start="2"><li>通过 ConfigProvider 中调用setContext 共享全局配置</li></ol></li></ul> <img src="/Study-Notes/assets/img/props1.624bb697.png" alt="center"> <img src="/Study-Notes/assets/img/props2.63391267.png" alt="center"> <p>7、如何接收组件事件
<img src="/Study-Notes/assets/img/event1.b478b80b.png" alt="center"></p> <p><code>Svelte</code> 打包的组件无法直接在 <code>DOM</code> 上监听事件，可以调用导入组件实例上的 <code>$on</code> 方法监听。
因但因业务需要，我们系统内是将外部事件抛到全局中的</p> <img src="/Study-Notes/assets/img/event2.eec9785e.png" alt="center"> <p>8、遇到的问题</p> <ol><li><p>如何使用原子化 CSS 库
因为 Scoped 的存在使用 UnoCSS 需要按需使用不同的插件，TailwindCSS 可以使用 PostCSS 后置处理</p></li> <li><p>使用原子化 CSS 导致的样式污染
使用 PostCSS 插件编译时加前缀的方式解决，但这种方式也导致原子化 CSS类的权重变高，会出现一些问题需要手动处理。</p></li> <li><p>使用原子化 CSS 导致编译为 Web Components 后样式失效
因为 Web Components 无样式侵入的特点，可以使用 UnoCSS 的 Web Components 模式，或者不用原子化CSS库，只用 scoped style。</p></li> <li><p>打包出的类型枚举在业务系统中导入后 undefined
需要在vite打包入口中显式导出TS枚举变量，vite会处理为JS对象</p></li></ol> <img src="/Study-Notes/assets/img/when.aaac70ea.png" alt="center"> <h3 id="建议"><a href="#建议" class="header-anchor">#</a> 建议</h3> <p><strong>1. 充分利用编译时性能优势</strong>
构建轻量级组件库时，发挥 <code>Svelte</code> 的编译时性能优势，创造高性能、轻便的组件。</p> <p><strong>2. 状态管理和数据流</strong>
使用<code>Svelte</code> 内置的状态管理系统，简化全局状态管理，提高代码可读性和可维护性。</p> <p><strong>3. 样式处理</strong>
充分利用 <code>Svelte</code>  的内置 <code>Scoped</code> 样式功能，避免样式污染问题，提高组件的可重用性和可维护性。</p> <p><strong>4. 轻松编译成 Web Components</strong>
利用 <code>Svelte</code>  内置的 <code>Custom Elements</code> 功能，轻松将组件编译成 <code>Web Components</code>，提高组件的可移植性，便于在不同项目中重用。</p></div> <footer class="page-edit"><!----> <!----></footer> <div><div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Study-Notes/前端生态/vscode扩展工具.html" class="prev">
        vscode扩展工具实现
      </a></span> <span class="next"><a href="/Study-Notes/前端生态/i18n.html">
        国际化解决方案
      </a>
      →
    </span></p></div> <div class="icp-footer"><p>Copyright© 2022-2025 _妄想何方</p> <a href="https://beian.miit.gov.cn/" target="_blank">蜀ICP备2022010321号-1</a></div></div> </main></div><div class="global-ui"></div></div>
    <script src="/Study-Notes/assets/js/app.3ac2ea1f.js" defer></script><script src="/Study-Notes/assets/js/2.950c954c.js" defer></script><script src="/Study-Notes/assets/js/3.bb3ecbf5.js" defer></script><script src="/Study-Notes/assets/js/13.1dd4895a.js" defer></script>
  </body>
</html>
